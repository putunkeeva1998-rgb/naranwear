<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NARAN | Premium Store</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://mapgl.2gis.com/api/js/v1"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --bg: #ffffff; 
            --text: #000000;
            --accent: #000000;
            --gray-light: #f4f4f4;
            --gray-border: #eeeeee;
            --red: #ff0000;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body { 
            margin: 0; 
            background: var(--bg); 
            font-family: 'Montserrat', sans-serif; 
            color: var(--text); 
            overflow-x: hidden; 
            -webkit-user-select: none;
        }

        /* –¢–ò–ü–û–ì–†–ê–§–ò–ö–ê */
        h1, h2, h3 { font-weight: 800; text-transform: uppercase; letter-spacing: 1px; margin: 0; }
        .price { font-weight: 600; font-size: 16px; }
        .old-price { text-decoration: line-through; color: #999; font-size: 12px; margin-right: 5px; }

        /* –•–ï–î–ï–† */
        .header { 
            background: #fff; 
            padding: 15px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            position: sticky; 
            top: 0; 
            z-index: 1000;
            border-bottom: 1px solid var(--gray-border);
        }

        .search-bar {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: white;
            display: flex; align-items: center; padding: 0 15px;
            z-index: 1001;
        }

        /* –ö–ê–¢–ï–ì–û–†–ò–ò */
        .cat-scroll { 
            display: flex; gap: 10px; padding: 15px; 
            overflow-x: auto; scrollbar-width: none; 
        }
        .cat-btn { 
            padding: 10px 20px; border: 1.5px solid #000; 
            background: none; font-size: 10px; font-weight: 800; 
            text-transform: uppercase; white-space: nowrap;
            transition: 0.2s;
        }
        .cat-btn.active { background: #000; color: #fff; }

        /* –°–ï–¢–ö–ê */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1px; background: var(--gray-border); }
        .product-card { background: white; padding-bottom: 20px; position: relative; }

        /* –°–õ–ê–ô–î–ï–† */
        .slider-box { position: relative; aspect-ratio: 3/4; overflow: hidden; }
        .slider-track { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; scrollbar-width: none; height: 100%; }
        .slider-track img { width: 100%; height: 100%; object-fit: cover; scroll-snap-align: start; flex-shrink: 0; }
        
        .dots { position: absolute; bottom: 10px; width: 100%; display: flex; justify-content: center; gap: 5px; }
        .dot { width: 4px; height: 4px; border-radius: 50%; background: rgba(0,0,0,0.2); }
        .dot.active { background: #000; width: 12px; border-radius: 2px; }

        /* –ö–ù–û–ü–ö–ò */
        .btn-black { 
            background: #000; color: #fff; border: none; 
            padding: 15px; font-weight: 800; font-size: 12px; 
            text-transform: uppercase; width: 100%; cursor: pointer;
        }
        .btn-outline { 
            background: none; border: 1px solid #000; 
            padding: 10px; font-weight: 800; font-size: 10px; 
        }

        /* –ë–û–¢–¢–û–ú –ù–ê–í */
        .nav { 
            position: fixed; bottom: 0; width: 100%; background: #fff; 
            display: flex; border-top: 1px solid var(--gray-border); 
            padding-bottom: env(safe-area-inset-bottom); z-index: 2000;
        }
        .nav-item { flex: 1; padding: 12px; text-align: center; background: none; border: none; position: relative; }
        .nav-item svg { width: 22px; height: 22px; stroke-width: 1.5; }
        .badge { 
            position: absolute; top: 8px; right: 25%; 
            background: var(--red); color: #fff; 
            font-size: 9px; min-width: 14px; height: 14px; 
            border-radius: 7px; display: flex; align-items: center; justify-content: center;
        }

        /* –ú–û–î–ê–õ–ö–ê FULL VIEW */
        .modal-full { position: fixed; inset: 0; background: #fff; z-index: 3000; overflow-y: auto; }
        .size-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 20px 0; }
        .size-chip { 
            padding: 12px; border: 1px solid #eee; text-align: center; 
            font-size: 12px; font-weight: 600; 
        }
        .size-chip.active { border-color: #000; background: #000; color: #fff; }

        /* –ê–î–ú–ò–ù–ö–ê */
        .admin-section { padding: 20px; background: #fafafa; border-radius: 0; margin-bottom: 20px; border: 1px solid #eee; }
        .input-minimal { 
            width: 100%; padding: 12px; border: 1px solid #eee; 
            margin-bottom: 10px; font-family: inherit; font-size: 14px; 
        }

        #map { width: 100%; height: 300px; margin: 15px 0; border: 1px solid #000; }
        
        .status-tag { 
            font-size: 10px; padding: 4px 8px; border-radius: 2px; 
            display: inline-block; font-weight: 800; text-transform: uppercase;
        }
    </style>
</head>
<body>

<div id="app" v-cloak>
    <div v-if="searchOpen" class="header">
        <input v-model="searchQuery" class="input-minimal" placeholder="–ü–û–ò–°–ö –¢–û–í–ê–†–ê..." style="margin-bottom:0; border:none; font-size:18px;">
        <button @click="searchOpen = false" style="background:none; border:none; font-size:24px;">‚úï</button>
    </div>

    <div v-else class="header">
        <button @click="showMenu = true; vibrate()" style="background:none; border:none;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="black"><path d="M3 12h18M3 6h18M3 18h18"/></svg>
        </button>
        <h1 @click="activeTab = 'catalog'">NARAN</h1>
        <button @click="searchOpen = true; vibrate()" style="background:none; border:none;">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
        </button>
    </div>

    <div v-if="showMenu" style="position:fixed; inset:0; background:rgba(255,255,255,0.98); z-index:5000; padding:40px;">
        <button @click="showMenu = false" style="float:right; border:none; background:none; font-size:30px;">‚úï</button>
        <div style="margin-top:100px; display:flex; flex-direction:column; gap:30px;">
            <h2 @click="activeInfo = 'about'; showMenu = false">–û –ù–ê–°</h2>
            <h2 @click="activeInfo = 'delivery_info'; showMenu = false">–î–û–°–¢–ê–í–ö–ê</h2>
            <h2 @click="activeInfo = 'returns'; showMenu = false">–í–û–ó–í–†–ê–¢</h2>
            <h2 @click="activeTab = 'profile'; showMenu = false" style="color: #999;">–õ–ò–ß–ù–´–ô –ö–ê–ë–ò–ù–ï–¢</h2>
        </div>
    </div>

    <div class="container" style="padding-bottom: 100px;">
        
        <div v-if="activeTab === 'catalog'">
            <div class="cat-scroll">
                <button @click="currentCat = ''; vibrate()" :class="['cat-btn', currentCat === '' ? 'active' : '']">–í–°–ï –¢–û–í–ê–†–´</button>
                <button v-for="c in categories" @click="currentCat = c; vibrate()" :class="['cat-btn', currentCat === c ? 'active' : '']">{{c}}</button>
            </div>

            <div class="grid">
                <div v-for="p in filteredProducts" :key="p.id" class="product-card" @click="openP(p)">
                    <div class="slider-box">
                        <div class="slider-track" @scroll="e => handleScroll(e, p)">
                            <img v-for="img in p.images" :src="img" loading="lazy">
                        </div>
                        <div class="dots">
                            <span v-for="(img, idx) in p.images" :class="['dot', idx === (p.aIdx || 0) ? 'active' : '']"></span>
                        </div>
                    </div>
                    <div style="padding: 12px; text-align: center;">
                        <div style="font-size: 11px; margin-bottom: 5px; height: 14px; overflow: hidden; opacity: 0.7;">{{p.category}}</div>
                        <div style="font-size: 13px; font-weight: 600; margin-bottom: 8px;">{{p.title}}</div>
                        <div class="price">
                            <span v-if="p.oldPrice" class="old-price">{{p.oldPrice}} ‚ÇΩ</span>
                            <span>{{p.price}} ‚ÇΩ</span>
                        </div>
                    </div>
                </div>
            </div>
            <div v-if="filteredProducts.length === 0" style="padding: 50px; text-align: center; opacity: 0.5;">–¢–û–í–ê–†–´ –ù–ï –ù–ê–ô–î–ï–ù–´</div>
        </div>

        <div v-if="activeTab === 'favs'" style="padding: 15px;">
            <h2 style="margin-bottom: 20px;">–ò–ó–ë–†–ê–ù–ù–û–ï</h2>
            <div v-if="favorites.length === 0" style="text-align: center; padding: 100px 0;">–ü–£–°–¢–û</div>
            <div class="grid" v-else>
                <div v-for="p in favItems" :key="p.id" class="product-card" @click="openP(p)">
                    <img :src="p.images[0]" style="width: 100%; aspect-ratio: 3/4; object-fit: cover;">
                    <div style="padding: 10px; text-align: center;">
                        <div style="font-size: 12px; font-weight: 600;">{{p.title}}</div>
                        <div class="price">{{p.price}} ‚ÇΩ</div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="activeTab === 'cart'" style="padding: 15px;">
            <h2 style="margin-bottom: 20px;">–ö–û–†–ó–ò–ù–ê</h2>
            <div v-if="cart.length === 0" style="text-align: center; padding: 100px 0;">–ö–û–†–ó–ò–ù–ê –ü–£–°–¢–ê</div>
            <div v-else>
                <div v-for="item in cart" :key="item.cartId" style="display: flex; gap: 15px; margin-bottom: 20px; border-bottom: 1px solid #f0f0f0; padding-bottom: 20px;">
                    <img :src="item.images[0]" style="width: 80px; height: 110px; object-fit: cover;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600;">{{item.title}}</div>
                        <div style="font-size: 12px; color: #666; margin: 5px 0;">–†–ê–ó–ú–ï–†: {{item.selS}} | –¶–í–ï–¢: {{item.selC}}</div>
                        <div style="display: flex; align-items: center; gap: 15px; margin-top: 10px;">
                            <button @click="updateQty(item, -1)" class="btn-outline" style="padding: 2px 10px;">-</button>
                            <span style="font-weight: 800;">{{item.qty}}</span>
                            <button @click="updateQty(item, 1)" class="btn-outline" style="padding: 2px 10px;">+</button>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div class="price">{{item.price * item.qty}} ‚ÇΩ</div>
                        <button @click="removeFromCart(item.cartId)" style="background:none; border:none; margin-top: 15px;">‚úï</button>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <h3 style="font-size: 14px; margin-bottom: 15px;">–î–ê–ù–ù–´–ï –ü–û–õ–£–ß–ê–¢–ï–õ–Ø</h3>
                    <input class="input-minimal" v-model="form.name" placeholder="–ò–ú–Ø">
                    <input class="input-minimal" v-model="form.phone" placeholder="–¢–ï–õ–ï–§–û–ù (11 –¶–ò–§–†)" type="tel">
                    
                    <h3 style="font-size: 14px; margin: 20px 0 15px;">–°–ü–û–°–û–ë –î–û–°–¢–ê–í–ö–ò</h3>
                    <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                        <button v-for="d in ['–°–î–≠–ö', '–ü–û–ß–¢–ê', '5POST']" @click="deliv = d; initMap()" :class="['cat-btn', deliv === d ? 'active' : '']" style="flex:1">{{d}}</button>
                    </div>

                    <div v-show="deliv">
                        <div style="font-size: 12px; padding: 10px; background: #000; color: #fff; margin-bottom: 5px;">
                            üìç {{address || '–í–´–ë–ï–†–ò–¢–ï –ü–£–ù–ö–¢ –ù–ê –ö–ê–†–¢–ï'}}
                        </div>
                        <div id="map"></div>
                    </div>
                </div>

                <div style="position: sticky; bottom: 80px; background: white; padding: 20px 0; border-top: 2px solid #000;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                        <span style="font-weight: 800;">–ò–¢–û–ì–û:</span>
                        <span class="price" style="font-size: 20px;">{{total}} ‚ÇΩ</span>
                    </div>
                    <button class="btn-black" @click="sendOrder" :disabled="!isValid">–û–§–û–†–ú–ò–¢–¨ –ó–ê–ö–ê–ó</button>
                </div>
            </div>
        </div>

        <div v-if="activeTab === 'profile'" style="padding: 15px;">
            <div style="text-align: center; margin-bottom: 40px;">
                <img :src="user.photo_url || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'" style="width: 80px; height: 80px; border-radius: 40px; border: 1px solid #000; padding: 5px;">
                <h2 style="margin-top: 15px;">{{user.first_name}}</h2>
                <button class="btn-outline" style="margin-top: 10px;" @click="tg.openTelegramLink('https://t.me/opttania')">–ü–û–î–î–ï–†–ñ–ö–ê</button>
            </div>

            <div v-if="myOrders.length > 0" style="margin-bottom: 40px;">
                <h3>–ú–û–ò –ó–ê–ö–ê–ó–´</h3>
                <div v-for="o in myOrders" :key="o.id" style="border: 1px solid #eee; padding: 15px; margin-top: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 12px; font-weight: 800;">‚Ññ{{o.order_id}}</span>
                        <span class="status-tag" :style="{background: getStatusColor(o.status), color: '#fff'}">{{o.status}}</span>
                    </div>
                    <div style="font-size: 11px; margin-top: 5px;">{{o.total}} ‚ÇΩ ‚Ä¢ {{o.cart.length}} —Ç–æ–≤.</div>
                </div>
            </div>

            <div v-if="isAdmin" class="admin-panel" style="border-top: 3px solid #000; padding-top: 30px;">
                <h2 style="color: var(--red);">ADMIN PANEL</h2>
                
                <div class="admin-section">
                    <h3>–ù–û–í–´–ô –¢–û–í–ê–†</h3>
                    <input class="input-minimal" v-model="newP.title" placeholder="–ù–ê–ó–í–ê–ù–ò–ï">
                    <textarea class="input-minimal" v-model="newP.desc" placeholder="–û–ü–ò–°–ê–ù–ò–ï" style="height: 80px;"></textarea>
                    <div style="display: flex; gap: 10px;">
                        <input class="input-minimal" v-model.number="newP.price" placeholder="–¶–ï–ù–ê">
                        <input class="input-minimal" v-model.number="newP.oldPrice" placeholder="–°–¢–ê–†–ê–Ø –¶–ï–ù–ê">
                    </div>
                    <select class="input-minimal" v-model="newP.category">
                        <option value="">–í–´–ë–ï–†–ò–¢–ï –ö–ê–¢–ï–ì–û–†–ò–Æ</option>
                        <option v-for="c in categories" :value="c">{{c}}</option>
                    </select>
                    <input class="input-minimal" v-model="newP.sizesInput" placeholder="–†–ê–ó–ú–ï–†–´ (S, M, L)">
                    <input class="input-minimal" v-model="newP.colorsInput" placeholder="–¶–í–ï–¢–ê (BLACK, WHITE)">
                    
                    <div style="margin: 10px 0;">
                        <input type="file" multiple @change="uploadToImgBB" id="fileInput" style="display:none">
                        <button class="btn-outline" @click="document.getElementById('fileInput').click()" :disabled="uploading">
                            {{ uploading ? '–ó–ê–ì–†–£–ó–ö–ê...' : '–ó–ê–ì–†–£–ó–ò–¢–¨ –§–û–¢–û (IMGBB)' }}
                        </button>
                        <div style="display: flex; gap: 5px; margin-top: 10px; overflow-x: auto;">
                            <img v-for="link in newP.images" :src="link" style="width: 50px; height: 50px; object-fit: cover;">
                        </div>
                    </div>

                    <button class="btn-black" @click="saveProduct">–°–û–•–†–ê–ù–ò–¢–¨ –¢–û–í–ê–†</button>
                </div>

                <div class="admin-section">
                    <h3>–£–ü–†–ê–í–õ–ï–ù–ò–ï –ó–ê–ö–ê–ó–ê–ú–ò ({{allOrders.length}})</h3>
                    <div v-for="o in allOrders" style="background: #fff; padding: 10px; margin-bottom: 10px; font-size: 12px; border: 1px solid #eee;">
                        <div><b>{{o.order_id}}</b> | {{o.user.name}}</div>
                        <div style="margin: 5px 0;">{{o.total}} ‚ÇΩ | {{o.delivery}}</div>
                        <div style="display: flex; gap: 5px;">
                            <select v-model="o.status" @change="updateOrderStatus(o)" class="input-minimal" style="margin:0; padding: 5px; flex:1">
                                <option>–í –û–ë–†–ê–ë–û–¢–ö–ï</option>
                                <option>–í –ü–£–¢–ò</option>
                                <option>–ì–û–¢–û–í</option>
                            </select>
                            <button @click="printOrder(o)" class="btn-outline">üñ®Ô∏è</button>
                        </div>
                    </div>
                </div>

                <div class="admin-section">
                    <h3>–¢–û–í–ê–†–´ ({{products.length}})</h3>
                    <div v-for="p in products" style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                        <img :src="p.images[0]" style="width: 40px; height: 50px; object-fit: cover;">
                        <div style="flex: 1; font-size: 10px; font-weight: 800;">{{p.title}}</div>
                        <button @click="toggleHide(p)" class="btn-outline" :style="{background: p.hidden ? '#ff0000' : '#eee', color: p.hidden ? '#fff' : '#000'}">üëÅ</button>
                        <button @click="editProduct(p)" class="btn-outline">‚úé</button>
                        <button @click="deleteProduct(p.id)" class="btn-outline">‚úï</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div v-if="selP" class="modal-full">
        <button @click="selP = null" style="position: fixed; top: 20px; left: 20px; z-index: 100; background: white; border: 1px solid #000; border-radius: 50%; width: 40px; height: 40px; font-size: 20px;">‚úï</button>
        
        <div class="slider-box" style="aspect-ratio: 1/1.2;">
            <div class="slider-track" @scroll="e => handleScroll(e, selP)">
                <img v-for="img in selP.images" :src="img">
            </div>
            <div class="dots">
                <span v-for="(img, idx) in selP.images" :class="['dot', idx === (selP.aIdx || 0) ? 'active' : '']"></span>
            </div>
        </div>

        <div style="padding: 25px;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                    <h2 style="font-size: 24px;">{{selP.title}}</h2>
                    <div class="price" style="font-size: 20px; margin-top: 5px;">{{selP.price}} ‚ÇΩ</div>
                </div>
                <button @click="toggleFav(selP)" style="background: none; border: none;">
                    <svg width="28" height="28" viewBox="0 0 24 24" :fill="isFav(selP) ? '#000' : 'none'" stroke="black" stroke-width="1.5">
                        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                    </svg>
                </button>
            </div>

            <p style="font-size: 14px; line-height: 1.6; color: #444; margin: 20px 0;">{{selP.desc}}</p>

            <h3 style="font-size: 12px;">–í–´–ë–ï–†–ò–¢–ï –†–ê–ó–ú–ï–†</h3>
            <div class="size-grid">
                <div v-for="s in selP.sizes" @click="selP.selS = s; vibrate()" :class="['size-chip', selP.selS === s ? 'active' : '']">{{s}}</div>
            </div>

            <h3 style="font-size: 12px;">–í–´–ë–ï–†–ò–¢–ï –¶–í–ï–¢</h3>
            <div class="size-grid">
                <div v-for="c in selP.colors" @click="selP.selC = c; vibrate()" :class="['size-chip', selP.selC === c ? 'active' : '']">{{c}}</div>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 30px;">
                <button class="btn-black" @click="addToCart(selP)">–î–û–ë–ê–í–ò–¢–¨ –í –ö–û–†–ó–ò–ù–£</button>
            </div>
        </div>
    </div>

    <nav class="nav">
        <button @click="activeTab = 'catalog'; vibrate()" :class="['nav-item', activeTab === 'catalog' ? 'active' : '']">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
        </button>
        <button @click="activeTab = 'favs'; vibrate()" :class="['nav-item', activeTab === 'favs' ? 'active' : '']">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
        </button>
        <button @click="activeTab = 'cart'; vibrate()" :class="['nav-item', activeTab === 'cart' ? 'active' : '']">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>
            <span v-if="cart.length" class="badge">{{cart.length}}</span>
        </button>
        <button @click="activeTab = 'profile'; vibrate()" :class="['nav-item', activeTab === 'profile' ? 'active' : '']">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        </button>
    </nav>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC6fihIMtOYZuPh-db3Tc6eiRgSikzydVw",
    authDomain: "naran-80077.firebaseapp.com",
    projectId: "naran-80077",
    storageBucket: "naran-80077.firebasestorage.app",
    messagingSenderId: "901156477154",
    appId: "IG-PR8PLCMF3C"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.fb = { db, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, serverTimestamp, where };
</script>

<script>
    const tg = window.Telegram.WebApp;
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                tg: window.Telegram.WebApp,
                isAdmin: false,
                adminId: 387881523,
                user: { first_name: '–ì–û–°–¢–¨' },
                activeTab: 'catalog',
                activeInfo: null,
                showMenu: false,
                searchOpen: false,
                searchQuery: '',
                currentCat: '',
                categories: ['–ø–∏–¥–∂–∞–∫–∏', '—Å–≤–∏—Ç–µ—Ä—ã','–∫–∞—Ä–¥–∏–≥–∞–Ω—ã', '–∫–æ—Å—Ç—é–º—ã', '–ª–æ–Ω–≥—Å–ª–∏–≤—ã', '—Ñ—É—Ç–±–æ–ª–∫–∏', '–∫–æ—Ä—Å–µ—Ç—ã', '–∫—É—Ä—Ç–∫–∏', '—ç–∫–æ—à—É–±—ã'],
                products: [],
                favorites: JSON.parse(localStorage.getItem('naran_favs')) || [],
                cart: JSON.parse(localStorage.getItem('naran_cart')) || [],
                allOrders: [],
                myOrders: [],
                selP: null,
                uploading: false,
                deliv: '',
                address: localStorage.getItem('naran_last_addr') || '',
                map: null,
                form: { name: '', phone: localStorage.getItem('naran_phone') || '' },
                newP: { title: '', price: '', oldPrice: '', images: [], category: '', desc: '', sizesInput: 'S, M, L', colorsInput: 'BLACK', id: null }
            }
        },
        computed: {
            filteredProducts() {
                try {
                    let list = this.products || [];
                    if (this.currentCat) {
                        list = list.filter(p => (p.category || '').toLowerCase() === this.currentCat.toLowerCase());
                    }
                    if (this.searchQuery) {
                        list = list.filter(p => p.title.toLowerCase().includes(this.searchQuery.toLowerCase()));
                    }
                    if (!this.isAdmin) {
                        list = list.filter(p => !p.hidden);
                    }
                    return list;
                } catch (e) { return []; }
            },
            favItems() {
                return this.favorites.map(id => this.products.find(p => p.id === id)).filter(p => p);
            },
            total() {
                return this.cart.reduce((sum, i) => sum + (i.price * i.qty), 0);
            },
            isValid() {
                const phoneClean = this.form.phone.replace(/\D/g, '');
                return this.form.name.length > 1 && phoneClean.length >= 10 && this.address;
            }
        },
        methods: {
            vibrate() { tg.HapticFeedback.impactOccurred('medium'); },
            handleScroll(e, p) { 
                if(!p) return;
                p.aIdx = Math.round(e.target.scrollLeft / e.target.offsetWidth); 
            },
            openP(p) { this.vibrate(); this.selP = { ...p, selS: p.sizes[0], selC: p.colors[0], aIdx: 0 }; },
            
            toggleFav(p) {
                const idx = this.favorites.indexOf(p.id);
                if (idx > -1) this.favorites.splice(idx, 1);
                else this.favorites.push(p.id);
                localStorage.setItem('naran_favs', JSON.stringify(this.favorites));
                this.vibrate();
            },
            isFav(p) { return this.favorites.includes(p.id); },

            addToCart(p) {
                const item = { ...p, cartId: Date.now(), qty: 1 };
                this.cart.push(item);
                localStorage.setItem('naran_cart', JSON.stringify(this.cart));
                this.selP = null;
                tg.HapticFeedback.notificationOccurred('success');
            },
            removeFromCart(cid) {
                this.cart = this.cart.filter(i => i.cartId !== cid);
                localStorage.setItem('naran_cart', JSON.stringify(this.cart));
            },
            updateQty(item, mod) {
                item.qty = Math.max(1, item.qty + mod);
                localStorage.setItem('naran_cart', JSON.stringify(this.cart));
            },

            async uploadToImgBB(e) {
                this.uploading = true;
                const files = e.target.files;
                for (let file of files) {
                    const form = new FormData();
                    form.append('image', file);
                    try {
                        const res = await fetch('https://api.imgbb.com/1/upload?key=839e62907e9a52f0159461b7771bcb2f', { method: 'POST', body: form });
                        const data = await res.json();
                        if (data.success) this.newP.images.push(data.data.display_url);
                    } catch (err) { alert('–û–®–ò–ë–ö–ê –ó–ê–ì–†–£–ó–ö–ò'); }
                }
                this.uploading = false;
            },

            async saveProduct() {
                if (!this.newP.title || !this.newP.images.length) return alert('–ó–ê–ü–û–õ–ù–ò–¢–ï –î–ê–ù–ù–´–ï');
                const pData = {
                    title: this.newP.title,
                    price: Number(this.newP.price),
                    oldPrice: Number(this.newP.oldPrice) || null,
                    category: this.newP.category,
                    desc: this.newP.desc,
                    images: this.newP.images,
                    sizes: this.newP.sizesInput.split(',').map(s => s.trim()),
                    colors: this.newP.colorsInput.split(',').map(c => c.trim()),
                    hidden: false,
                    updatedAt: window.fb.serverTimestamp()
                };
                try {
                    if (this.newP.id) {
                        await window.fb.updateDoc(window.fb.doc(window.fb.db, "products", this.newP.id), pData);
                    } else {
                        await window.fb.addDoc(window.fb.collection(window.fb.db, "products"), pData);
                    }
                    this.newP = { title: '', price: '', oldPrice: '', images: [], category: '', desc: '', sizesInput: 'S, M, L', colorsInput: 'BLACK', id: null };
                    alert('–£–°–ü–ï–®–ù–û');
                } catch (e) { console.error(e); }
            },

            async toggleHide(p) {
                await window.fb.updateDoc(window.fb.doc(window.fb.db, "products", p.id), { hidden: !p.hidden });
            },
            async deleteProduct(id) {
                if(confirm('–£–î–ê–õ–ò–¢–¨?')) await window.fb.deleteDoc(window.fb.doc(window.fb.db, "products", id));
            },
            editProduct(p) {
                this.newP = { ...p, sizesInput: p.sizes.join(', '), colorsInput: p.colors.join(', ') };
                window.scrollTo(0, 500);
            },

            initMap() {
                this.$nextTick(() => {
                    setTimeout(() => {
                        if (this.map) this.map.destroy();
                        this.map = new mapgl.Map('map', {
                            center: [37.6175, 55.7558],
                            zoom: 12,
                            key: 'cab82c94-e619-42eb-9814-3361712feaf0'
                        });
                        this.map.on('click', (e) => {
                            this.getAddress(e.lngLat[1], e.lngLat[0]);
                        });
                        this.locateMe();
                    }, 100);
                });
            },
            locateMe() {
                navigator.geolocation.getCurrentPosition(p => {
                    const c = [p.coords.longitude, p.coords.latitude];
                    this.map.setCenter(c);
                    this.getAddress(c[1], c[0]);
                });
            },
            async getAddress(lat, lon) {
                try {
                    const res = await fetch(`https://catalog.api.2gis.com/3.0/items/geocode?lat=${lat}&lon=${lon}&fields=items.address&key=cab82c94-e619-42eb-9814-3361712feaf0`);
                    const d = await res.json();
                    if (d.result?.items?.length) {
                        this.address = d.result.items[0].address_name || d.result.items[0].name;
                        localStorage.setItem('naran_last_addr', this.address);
                    }
                } catch (e) {}
            },

            async sendOrder() {
                this.vibrate();
                const oid = `${new Date().getDate()}${new Date().getMonth()+1}-${Math.floor(10000+Math.random()*90000)}`;
                const order = {
                    order_id: oid,
                    user_id: this.user.id || 'guest',
                    user: this.form,
                    cart: this.cart.map(i => ({ title: i.title, size: i.selS, color: i.selC, qty: i.qty })),
                    total: this.total,
                    delivery: this.deliv,
                    address: this.address,
                    status: '–í –û–ë–†–ê–ë–û–¢–ö–ï',
                    createdAt: window.fb.serverTimestamp()
                };
                
                await window.fb.addDoc(window.fb.collection(window.fb.db, "orders"), order);
                localStorage.setItem('naran_phone', this.form.phone);
                
                // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ —Ç–µ–ª–µ–≥—Ä–∞–º (—á–µ—Ä–µ–∑ sendData)
                tg.sendData(JSON.stringify(order));
                
                alert('–ó–ê–ö–ê–ó –û–§–û–†–ú–õ–ï–ù! ‚Ññ' + oid);
                this.cart = [];
                localStorage.removeItem('naran_cart');
                this.activeTab = 'profile';
            },

            getStatusColor(s) {
                if(s === '–í –û–ë–†–ê–ë–û–¢–ö–ï') return '#999';
                if(s === '–í –ü–£–¢–ò') return '#000';
                return '#27ae60';
            },
            async updateOrderStatus(o) {
                await window.fb.updateDoc(window.fb.doc(window.fb.db, "orders", o.id), { status: o.status });
            },
            printOrder(o) {
                const win = window.open('', '_blank');
                win.document.write(`<h1>–ó–ê–ö–ê–ó ${o.order_id}</h1><p>${o.user.name} ${o.user.phone}</p><p>${o.address}</p><hr>`);
                o.cart.forEach(i => win.document.write(`<p>${i.title} - ${i.size} - ${i.qty}—à—Ç</p>`));
                win.print();
            }
        },
        mounted() {
            tg.ready();
            tg.expand();
            if (tg.initDataUnsafe?.user) {
                this.user = tg.initDataUnsafe.user;
                this.isAdmin = Number(this.user.id) === this.adminId;
            }

            const checkFb = setInterval(() => {
                if (window.fb) {
                    clearInterval(checkFb);
                    
                    // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Ç–æ–≤–∞—Ä—ã
                    window.fb.onSnapshot(window.fb.query(window.fb.collection(window.fb.db, "products"), window.fb.orderBy("updatedAt", "desc")), snap => {
                        this.products = snap.docs.map(d => ({ id: d.id, ...d.data(), aIdx: 0 }));
                    });

                    // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –º–æ–∏ –∑–∞–∫–∞–∑—ã
                    if (this.user.id) {
                        const myQ = window.fb.query(window.fb.collection(window.fb.db, "orders"), window.fb.where("user_id", "==", this.user.id));
                        window.fb.onSnapshot(myQ, snap => {
                            this.myOrders = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        });
                    }

                    // –î–ª—è –∞–¥–º–∏–Ω–∞ - –≤—Å–µ –∑–∞–∫–∞–∑—ã
                    if (this.isAdmin) {
                        window.fb.onSnapshot(window.fb.query(window.fb.collection(window.fb.db, "orders"), window.fb.orderBy("createdAt", "desc")), snap => {
                            this.allOrders = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        });
                    }
                }
            }, 100);
        }
    }).mount('#app');
</script>

</body>
</html>
