<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NARAN</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://mapgl.2gis.com/api/js/v1"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --black: #000000;
            --white: #ffffff;
            --gray: #f2f2f2;
            --border: #eeeeee;
            --font: 'Montserrat', sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; margin: 0; padding: 0; }
        body { font-family: var(--font); background: var(--white); color: var(--black); overflow-x: hidden; -webkit-user-select: none; }

        [v-cloak] { display: none; }

        /* HEADER */
        header {
            position: sticky; top: 0; background: var(--white); z-index: 1000;
            display: flex; align-items: center; justify-content: space-between;
            padding: 15px 20px; border-bottom: 1px solid var(--gray);
        }
        .logo { font-weight: 800; letter-spacing: 5px; font-size: 20px; text-transform: uppercase; text-align: center; flex: 1; }
        
        /* SEARCH */
        .search-bar {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--white); display: flex; align-items: center; padding: 0 20px; z-index: 1100;
        }
        .search-bar input { flex: 1; border: none; border-bottom: 1px solid var(--black); padding: 8px; font-family: var(--font); font-size: 16px; }

        /* BURGER MENU */
        .side-menu {
            position: fixed; top: 0; left: 0; width: 280px; height: 100%;
            background: var(--white); z-index: 2000; padding: 60px 30px;
            transform: translateX(-100%); transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-right: 1px solid var(--gray);
        }
        .side-menu.open { transform: translateX(0); }
        .menu-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 1999; backdrop-filter: blur(2px); }
        .menu-link { display: block; font-size: 16px; margin-bottom: 25px; text-decoration: none; color: var(--black); text-transform: uppercase; font-weight: 400; letter-spacing: 1px; }

        /* CATEGORIES */
        .cat-container { display: flex; overflow-x: auto; padding: 15px 20px; gap: 10px; scrollbar-width: none; }
        .cat-container::-webkit-scrollbar { display: none; }
        .cat-btn {
            padding: 10px 20px; border: 1px solid var(--black); background: var(--white);
            font-size: 11px; font-weight: 600; text-transform: uppercase; white-space: nowrap; cursor: pointer; transition: 0.2s;
        }
        .cat-btn.active { background: var(--black); color: var(--white); }

        /* PRODUCT GRID */
        .product-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1px; background: var(--gray); border-top: 1px solid var(--gray); }
        .p-card { background: var(--white); position: relative; display: flex; flex-direction: column; padding-bottom: 15px; overflow: hidden; }
        .p-img-slider { width: 100%; aspect-ratio: 3/4; position: relative; overflow: hidden; background: #fafafa; }
        .p-img-slider img { width: 100%; height: 100%; object-fit: cover; transition: opacity 0.3s; }
        
        .p-info { padding: 12px; flex-grow: 1; }
        .p-title { font-size: 11px; text-transform: uppercase; line-height: 1.4; height: 30px; overflow: hidden; margin-bottom: 8px; font-weight: 400; }
        .p-price { font-weight: 800; font-size: 14px; letter-spacing: 0.5px; }
        .p-old-price { font-size: 10px; color: #999; text-decoration: line-through; margin-left: 5px; font-weight: 400; }
        .p-sizes-label { font-size: 9px; color: #888; margin-top: 8px; text-transform: uppercase; }

        .slide-dots { position: absolute; bottom: 8px; width: 100%; display: flex; justify-content: center; gap: 4px; pointer-events: none; }
        .dot { width: 4px; height: 4px; background: rgba(0,0,0,0.2); border-radius: 50%; }
        .dot.active { background: var(--black); width: 12px; border-radius: 2px; }

        /* FULL VIEW */
        .full-view { position: fixed; inset: 0; background: var(--white); z-index: 3000; overflow-y: auto; padding-bottom: 100px; }
        .close-btn { position: fixed; top: 20px; right: 20px; z-index: 3100; background: var(--white); border: 1px solid #000; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
        
        .fv-slider { width: 100%; height: 60vh; background: var(--gray); position: relative; }
        .fv-slider img { width: 100%; height: 100%; object-fit: cover; }
        
        .fv-content { padding: 30px 20px; }
        .fv-category { font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 10px; }
        .fv-title { font-size: 22px; font-weight: 800; text-transform: uppercase; margin-bottom: 15px; }
        .fv-price { font-size: 20px; font-weight: 400; margin-bottom: 25px; }

        .size-selector { display: flex; flex-wrap: wrap; gap: 10px; margin: 20px 0; }
        .size-chip { border: 1px solid #000; padding: 12px 18px; font-size: 12px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .size-chip.active { background: #000; color: #fff; }

        .fv-actions { position: fixed; bottom: 20px; left: 20px; right: 20px; display: flex; gap: 10px; z-index: 3005; }
        .btn-main { flex: 1; background: #000; color: #fff; border: none; height: 55px; font-weight: 800; text-transform: uppercase; font-size: 12px; letter-spacing: 1px; }
        .btn-outline { width: 55px; height: 55px; border: 1px solid #000; background: #fff; display: flex; align-items: center; justify-content: center; }

        /* CART & ORDERS */
        .cart-item { display: flex; gap: 15px; padding: 15px 20px; border-bottom: 1px solid var(--gray); position: relative; }
        .cart-img { width: 80px; height: 100px; object-fit: cover; }
        .qty-ctrl { display: flex; align-items: center; gap: 15px; margin-top: 10px; }
        .qty-btn { width: 28px; height: 28px; border: 1px solid #000; background: #fff; font-size: 18px; line-height: 1; }

        .badge { position: absolute; top: -5px; right: -5px; background: #ff0000; color: #fff; font-size: 9px; font-weight: 800; width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }

        /* MAP */
        #map-container { width: 100%; height: 300px; margin-top: 15px; border: 1px solid #000; }
        .delivery-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 20px 0; }

        /* ADMIN */
        .admin-panel { padding: 25px 20px; background: #fdfdfd; border-top: 5px solid #000; margin-top: 40px; }
        .admin-title { font-weight: 800; font-size: 18px; text-transform: uppercase; margin-bottom: 20px; text-align: center; letter-spacing: 3px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 10px; font-weight: 800; margin-bottom: 5px; text-transform: uppercase; }
        .inp { width: 100%; padding: 12px; border: 1px solid #ddd; font-family: var(--font); font-size: 14px; }
        .admin-p-card { display: flex; align-items: center; gap: 10px; padding: 10px; border: 1px solid #eee; margin-bottom: 10px; background: #fff; }

        /* NAV */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 75px; background: #fff; border-top: 1px solid var(--gray); display: flex; justify-content: space-around; align-items: center; z-index: 2500; padding-bottom: env(safe-area-inset-bottom); }
        .nav-tab { background: none; border: none; display: flex; flex-direction: column; align-items: center; gap: 4px; color: #b1b1b1; text-transform: uppercase; font-size: 8px; font-weight: 600; letter-spacing: 0.5px; position: relative; }
        .nav-tab.active { color: #000; }
        .nav-tab svg { width: 22px; height: 22px; }

        /* ANIMATIONS */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body>

<div id="app" v-cloak>
    
    <header>
        <button @click="isMenuOpen = true; triggerHaptic()" style="background:none; border:none;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="1.5"><path d="M3 12h18M3 6h18M3 18h18"/></svg>
        </button>
        <div class="logo">NARAN</div>
        <button @click="isSearchOpen = true; triggerHaptic()" style="background:none; border:none;">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="1.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
        </button>

        <div v-if="isSearchOpen" class="search-bar">
            <input v-model="searchQuery" placeholder="–ü–û–ò–°–ö –¢–û–í–ê–†–ê..." autofocus @input="triggerHaptic()">
            <button @click="isSearchOpen = false; searchQuery = ''" style="background:none; border:none; margin-left:15px; font-weight:800;">‚úï</button>
        </div>
    </header>

    <div v-if="isMenuOpen" class="menu-overlay" @click="isMenuOpen = false"></div>
    <div class="side-menu" :class="{open: isMenuOpen}">
        <a href="#" class="menu-link" @click="isMenuOpen = false">–û –ù–ê–°</a>
        <a href="#" class="menu-link" @click="isMenuOpen = false">–î–û–°–¢–ê–í–ö–ê</a>
        <a href="#" class="menu-link" @click="isMenuOpen = false">–í–û–ó–í–†–ê–¢</a>
        <div style="margin-top: 100px; font-size: 9px; color: #ccc; letter-spacing: 3px;">NARAN PREMIUM STORE</div>
    </div>

    <main style="padding-bottom: 100px;">
        
        <div v-if="currentTab === 'catalog'">
            <div class="cat-container">
                <div class="cat-btn" :class="{active: selectedCategory === ''}" @click="setCategory('')">–í–°–ï –¢–û–í–ê–†–´</div>
                <div v-for="cat in categories" :key="cat.id" class="cat-btn" :class="{active: selectedCategory === cat.name}" @click="setCategory(cat.name)">
                    {{ cat.name }}
                </div>
            </div>

            <div class="product-grid" v-if="filteredProducts.length > 0">
                <div v-for="product in filteredProducts" :key="product.id" class="p-card" @click="openProduct(product)">
                    <div class="p-img-slider" @touchstart="handleTouchStart" @touchend="(e) => handleTouchEnd(e, product)">
                        <img :src="product.images[product.activeIdx || 0]" loading="lazy">
                        <div class="slide-dots" v-if="product.images.length > 1">
                            <div v-for="(img, idx) in product.images" :class="['dot', {active: idx === (product.activeIdx || 0)}]"></div>
                        </div>
                    </div>
                    <div class="p-info">
                        <div class="p-title">{{ product.title }}</div>
                        <div class="p-price">
                            {{ product.price }} ‚ÇΩ
                            <span v-if="product.oldPrice" class="p-old-price">{{ product.oldPrice }} ‚ÇΩ</span>
                        </div>
                        <div class="p-sizes-label">{{ formatSizes(product.sizes) }}</div>
                    </div>
                </div>
            </div>
            <div v-else style="padding: 100px 20px; text-align: center; color: #999; letter-spacing: 2px; font-size: 10px;">
                –¢–û–í–ê–†–û–í –ù–ï –ù–ê–ô–î–ï–ù–û
            </div>
        </div>

        <div v-if="currentTab === 'favorites'" style="padding: 20px;">
            <h2 style="font-weight: 800; letter-spacing: 3px; margin-bottom: 25px; font-size: 16px;">–ò–ó–ë–†–ê–ù–ù–û–ï</h2>
            <div class="product-grid" v-if="favorites.length > 0">
                <div v-for="product in favoriteProducts" :key="product.id" class="p-card" @click="openProduct(product)">
                    <div class="p-img-slider">
                        <img :src="product.images[0]">
                    </div>
                    <div class="p-info">
                        <div class="p-title">{{ product.title }}</div>
                        <div class="p-price">{{ product.price }} ‚ÇΩ</div>
                    </div>
                </div>
            </div>
            <div v-else style="padding: 60px 0; text-align: center; color: #999; font-size: 11px;">–°–ü–ò–°–û–ö –ü–£–°–¢</div>
        </div>

        <div v-if="currentTab === 'cart'" style="padding: 20px;">
            <h2 style="font-weight: 800; letter-spacing: 3px; margin-bottom: 25px; font-size: 16px;">–ö–û–†–ó–ò–ù–ê</h2>
            <div v-if="cart.length > 0">
                <div v-for="(item, index) in cart" :key="index" class="cart-item">
                    <img :src="item.images[0]" class="cart-img" @click="openProduct(item)">
                    <div style="flex: 1;">
                        <div style="font-size: 11px; font-weight: 800; text-transform: uppercase;">{{ item.title }}</div>
                        <div style="font-size: 10px; color: #888; margin-top: 4px;">–†–ê–ó–ú–ï–†: {{ item.selectedSize }}</div>
                        <div class="qty-ctrl">
                            <button class="qty-btn" @click="updateQty(index, -1)">-</button>
                            <span style="font-size: 14px; font-weight: 800;">{{ item.qty }}</span>
                            <button class="qty-btn" @click="updateQty(index, 1)">+</button>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: 800; font-size: 14px;">{{ item.price * item.qty }} ‚ÇΩ</div>
                        <button @click="removeFromCart(index)" style="background:none; border:none; margin-top: 25px; color: #ff0000;">‚úï</button>
                    </div>
                </div>

                <div style="margin-top: 40px;">
                    <div class="form-group">
                        <label>–ö–û–ù–¢–ê–ö–¢–ù–´–ô –¢–ï–õ–ï–§–û–ù</label>
                        <input v-model="orderForm.phone" class="inp" placeholder="89000000000" maxlength="12">
                    </div>
                    <div class="delivery-grid">
                        <button v-for="type in ['–°–î–≠–ö', '–ü–û–ß–¢–ê', '5POST']" 
                                class="cat-btn" 
                                :class="{active: deliveryType === type}"
                                @click="selectDelivery(type)">{{ type }}</button>
                    </div>
                    
                    <div id="map-container" v-show="deliveryType"></div>
                    <div v-if="address" style="margin-top: 15px; padding: 15px; background: #000; color: #fff; font-size: 11px; text-transform: uppercase; letter-spacing: 1px;">
                        –ü—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏: {{ address }}
                    </div>

                    <div style="margin-top: 40px; border-top: 2px solid #000; padding-top: 20px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 10px; color: #888;">–ò–¢–û–ì–û –ö –û–ü–õ–ê–¢–ï:</div>
                            <div style="font-size: 24px; font-weight: 800;">{{ totalPrice }} ‚ÇΩ</div>
                        </div>
                        <button class="btn-main" style="flex: 0 0 160px;" @click="checkout">–û–§–û–†–ú–ò–¢–¨</button>
                    </div>
                </div>
            </div>
            <div v-else style="padding: 100px 0; text-align: center; color: #999; font-size: 11px;">–í–ê–®–ê –ö–û–†–ó–ò–ù–ê –ü–£–°–¢–ê</div>
        </div>

        <div v-if="currentTab === 'profile'">
            <div style="padding: 40px 20px; display: flex; align-items: center; gap: 20px; background: #fafafa; border-bottom: 1px solid #eee;">
                <img :src="user.photo_url || 'https://via.placeholder.com/100'" style="width: 80px; height: 80px; border-radius: 50%; border: 1px solid #000;">
                <div>
                    <div style="font-weight: 800; font-size: 20px; text-transform: uppercase;">{{ user.first_name || '–ö–õ–ò–ï–ù–¢' }}</div>
                    <button @click="tg.openTelegramLink('https://t.me/opttania')" style="background:none; border:none; border-bottom: 1px solid #000; font-size: 11px; margin-top: 8px; font-weight: 600;">–ü–û–î–î–ï–†–ñ–ö–ê</button>
                </div>
            </div>

            <div style="padding: 25px 20px;">
                <h3 style="font-weight: 800; font-size: 12px; letter-spacing: 2px; margin-bottom: 20px;">–ú–û–ò –ó–ê–ö–ê–ó–´</h3>
                <div v-for="order in myOrders" :key="order.id" style="border: 1px solid #eee; padding: 15px; margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span style="font-weight: 800; font-size: 13px;">‚Ññ{{ order.order_id }}</span>
                        <span style="font-size: 10px; padding: 4px 8px; background: #000; color: #fff; text-transform: uppercase;">{{ order.status }}</span>
                    </div>
                    <div style="font-size: 11px; color: #666;">–°—É–º–º–∞: {{ order.total }} ‚ÇΩ</div>
                </div>
            </div>

            <div v-if="isAdmin" class="admin-panel">
                <div class="admin-title">ADMIN PANEL</div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 30px;">
                    <div style="background:#000; color:#fff; padding:15px; text-align:center;">
                        <div style="font-size:9px;">–í–´–†–£–ß–ö–ê</div>
                        <div style="font-size:18px; font-weight:800;">{{ totalRevenue }} ‚ÇΩ</div>
                    </div>
                    <div style="background:#000; color:#fff; padding:15px; text-align:center;">
                        <div style="font-size:9px;">–ó–ê–ö–ê–ó–û–í</div>
                        <div style="font-size:18px; font-weight:800;">{{ orders.length }}</div>
                    </div>
                </div>

                <div style="background: #fff; border: 1px solid #000; padding: 20px;">
                    <h4 style="font-size:11px; margin-bottom:15px;">{{ editMode ? '–ò–ó–ú–ï–ù–ò–¢–¨ –¢–û–í–ê–†' : '–î–û–ë–ê–í–ò–¢–¨ –¢–û–í–ê–†' }}</h4>
                    <input v-model="newP.title" class="inp form-group" placeholder="–ù–ê–ó–í–ê–ù–ò–ï">
                    <textarea v-model="newP.desc" class="inp form-group" placeholder="–û–ü–ò–°–ê–ù–ò–ï" rows="3"></textarea>
                    <div style="display:flex; gap:10px;" class="form-group">
                        <input v-model="newP.price" type="number" class="inp" placeholder="–¶–ï–ù–ê">
                        <input v-model="newP.oldPrice" type="number" class="inp" placeholder="–°–¢–ê–†–ê–Ø –¶–ï–ù–ê">
                    </div>
                    <select v-model="newP.category" class="inp form-group">
                        <option value="">–ö–ê–¢–ï–ì–û–†–ò–Ø</option>
                        <option v-for="c in categories" :value="c.name">{{ c.name }}</option>
                    </select>
                    <input v-model="newP.sizes" class="inp form-group" placeholder="–†–ê–ó–ú–ï–†–´ (–ß–ï–†–ï–ó –ó–ê–ü–Ø–¢–£–Æ)">
                    
                    <input type="file" id="fileInp" multiple style="display:none" @change="uploadImages">
                    <button @click="document.getElementById('fileInp').click()" class="btn-main" style="background:#fff; color:#000; border:1px solid #000; margin-bottom:10px; width:100%;">
                        {{ loading ? '–ó–ê–ì–†–£–ó–ö–ê...' : '–í–´–ë–†–ê–¢–¨ –§–û–¢–û' }}
                    </button>

                    <div style="display:flex; gap:5px; overflow-x:auto; margin-bottom:20px;">
                        <img v-for="img in newP.images" :src="img" style="width:50px; height:70px; object-fit:cover; border:1px solid #eee;">
                    </div>

                    <button @click="saveProduct" class="btn-main" style="width:100%;">{{ editMode ? '–°–û–•–†–ê–ù–ò–¢–¨' : '–û–ü–£–ë–õ–ò–ö–û–í–ê–¢–¨' }}</button>
                    <button v-if="editMode" @click="resetForm" class="btn-main" style="width:100%; margin-top:5px; background: #ff0000;">–û–¢–ú–ï–ù–ê</button>
                </div>

                <div style="margin-top: 30px;">
                    <h4 style="font-size:11px; margin-bottom:10px;">–£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–ê–¢–ï–ì–û–†–ò–Ø–ú–ò</h4>
                    <div style="display:flex; gap:5px;">
                        <input v-model="newCatName" class="inp" placeholder="–ù–û–í–ê–Ø –ö–ê–¢–ï–ì–û–†–ò–Ø">
                        <button @click="addCategory" class="btn-main" style="width:60px;">+</button>
                    </div>
                    <div style="display:flex; flex-wrap:wrap; gap:5px; margin-top:10px;">
                        <div v-for="c in categories" class="cat-btn" style="padding: 5px 10px;">
                            {{ c.name }} <span @click="deleteCategory(c.id)" style="color:red; margin-left:10px">‚úï</span>
                        </div>
                    </div>
                </div>

                <h4 style="margin-top:40px; font-size:11px; margin-bottom:15px;">–¢–û–í–ê–†–´ ({{ products.length }})</h4>
                <div v-for="pr in products" :key="pr.id" class="admin-p-card">
                    <img :src="pr.images[0]" style="width:40px; height:55px; object-fit:cover;">
                    <div style="flex:1; font-size:10px; font-weight:800;">{{ pr.title }} <br> {{ pr.price }} ‚ÇΩ</div>
                    <button @click="editProduct(pr)">‚úèÔ∏è</button>
                    <button @click="toggleVisible(pr)">{{ pr.hidden ? 'üëÅÔ∏è' : 'üï∂Ô∏è' }}</button>
                    <button @click="deleteProduct(pr.id)" style="color:red">‚úï</button>
                </div>
                
                <h4 style="margin-top:40px; font-size:11px; margin-bottom:15px;">–ë–ê–ó–ê –ó–ê–ö–ê–ó–û–í</h4>
                <div v-for="ord in orders" :key="ord.id" style="border: 1px solid #eee; padding:15px; margin-bottom:10px; background:#fff;">
                    <div style="display:flex; justify-content:space-between; font-size:11px; font-weight:800; margin-bottom:10px;">
                        <span>‚Ññ{{ ord.order_id }}</span>
                        <select :value="ord.status" @change="(e) => updateOrderStatus(ord.id, e.target.value)" style="font-size:9px;">
                            <option>–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</option>
                            <option>–í –ø—É—Ç–∏</option>
                            <option>–ì–æ—Ç–æ–≤</option>
                        </select>
                    </div>
                    <div style="font-size:10px;">
                        {{ ord.phone }} | {{ ord.total }} ‚ÇΩ <br>
                        {{ ord.address }}
                    </div>
                    <button @click="printOrder(ord)" style="margin-top:10px; font-size:9px; font-weight:800; border-bottom:1px solid #000;">–ü–ï–ß–ê–¢–¨ –ß–ï–ö–ê (PDF)</button>
                </div>
            </div>
        </div>
    </main>

    <transition name="fade">
        <div v-if="selectedProduct" class="full-view">
            <button class="close-btn" @click="selectedProduct = null">‚úï</button>
            <div class="fv-slider">
                <img :src="selectedProduct.images[fvIdx]" @click="fvIdx = (fvIdx + 1) % selectedProduct.images.length">
                <div class="slide-dots">
                    <div v-for="(img, idx) in selectedProduct.images" :class="['dot', {active: idx === fvIdx}]"></div>
                </div>
            </div>
            <div class="fv-content">
                <div class="fv-category">{{ selectedProduct.category }}</div>
                <h1 class="fv-title">{{ selectedProduct.title }}</h1>
                <div class="fv-price">{{ selectedProduct.price }} ‚ÇΩ</div>
                
                <div style="font-weight: 800; font-size: 11px; margin-bottom: 10px;">–í–´–ë–ï–†–ò–¢–ï –†–ê–ó–ú–ï–†:</div>
                <div class="size-selector">
                    <div v-for="s in selectedProduct.sizes" 
                         :class="['size-chip', {active: selectedSize === s}]"
                         @click="selectedSize = s; triggerHaptic()">{{ s }}</div>
                </div>

                <div style="font-weight: 800; font-size: 11px; margin-bottom: 10px; margin-top: 30px;">–û–ü–ò–°–ê–ù–ò–ï:</div>
                <p style="font-size: 14px; line-height: 1.7; color: #444; white-space: pre-line;">{{ selectedProduct.desc }}</p>
            </div>
            <div class="fv-actions">
                <button class="btn-outline" @click="toggleFavorite(selectedProduct)">
                    <svg width="24" height="24" viewBox="0 0 24 24" :fill="isFav(selectedProduct.id) ? 'black' : 'none'" stroke="black" stroke-width="1.5"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l8.72-8.72 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                </button>
                <button class="btn-main" @click="addToCart(selectedProduct)">–î–û–ë–ê–í–ò–¢–¨ –í –ö–û–†–ó–ò–ù–£</button>
            </div>
        </div>
    </transition>

    <nav class="bottom-nav">
        <button class="nav-tab" :class="{active: currentTab === 'catalog'}" @click="currentTab = 'catalog'; triggerHaptic()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
            –ö–ê–¢–ê–õ–û–ì
        </button>
        <button class="nav-tab" :class="{active: currentTab === 'favorites'}" @click="currentTab = 'favorites'; triggerHaptic()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l8.72-8.72 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
            –ò–ó–ë–†–ê–ù–ù–û–ï
        </button>
        <button class="nav-tab" :class="{active: currentTab === 'cart'}" @click="currentTab = 'cart'; triggerHaptic()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>
            –ö–û–†–ó–ò–ù–ê
            <div v-if="cart.length" class="badge">{{ cart.length }}</div>
        </button>
        <button class="nav-tab" :class="{active: currentTab === 'profile'}" @click="currentTab = 'profile'; triggerHaptic()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            –ü–†–û–§–ò–õ–¨
        </button>
    </nav>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
    // –ö–û–ù–§–ò–ì FIREBASE
    const firebaseConfig = {
        apiKey: "AIzaSyC6fihIMtOYZuPh-db3Tc6eiRgSikzydVw",
        projectId: "naran-clothes",
        appId: "1:387881523:web:9f8e8b"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const tg = window.Telegram.WebApp;
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                currentTab: 'catalog',
                isMenuOpen: false,
                isSearchOpen: false,
                searchQuery: '',
                selectedCategory: '',
                
                products: [],
                categories: [],
                orders: [],
                
                favorites: JSON.parse(localStorage.getItem('naran_fav') || '[]'),
                cart: JSON.parse(localStorage.getItem('naran_cart') || '[]'),
                
                user: {},
                isAdmin: false,
                adminId: 387881523,

                selectedProduct: null,
                fvIdx: 0,
                selectedSize: '',
                
                touchStartX: 0,
                
                orderForm: { phone: '' },
                deliveryType: '',
                address: localStorage.getItem('naran_last_addr') || '',
                
                map: null,
                marker: null,

                // Admin State
                newP: { title: '', desc: '', price: '', oldPrice: '', category: '', sizes: '', images: [] },
                editMode: false,
                editId: null,
                loading: false,
                newCatName: ''
            }
        },
        computed: {
            filteredProducts() {
                try {
                    if (!this.products || this.products.length === 0) return [];
                    let result = this.products.filter(p => !p.hidden);
                    if (this.selectedCategory) {
                        result = result.filter(p => p.category?.toLowerCase() === this.selectedCategory.toLowerCase());
                    }
                    if (this.searchQuery) {
                        result = result.filter(p => p.title.toLowerCase().includes(this.searchQuery.toLowerCase().trim()));
                    }
                    return result;
                } catch (e) {
                    console.error("Filter error:", e);
                    return [];
                }
            },
            favoriteProducts() {
                return this.products.filter(p => this.favorites.includes(p.id));
            },
            totalPrice() {
                return this.cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            },
            myOrders() {
                return this.orders.filter(o => o.uid === this.user.id);
            },
            totalRevenue() {
                return this.orders.reduce((sum, o) => sum + (Number(o.total) || 0), 0);
            }
        },
        methods: {
            triggerHaptic() {
                try { tg.HapticFeedback.impactOccurred('light'); } catch(e) {}
            },
            setCategory(name) {
                try {
                    this.selectedCategory = name === null ? '' : name;
                    this.triggerHaptic();
                } catch(e) { this.selectedCategory = ''; }
            },
            formatSizes(sizes) {
                if (!sizes) return '';
                return Array.isArray(sizes) ? sizes.join(' ') : String(sizes).replace(/,/g, ' ');
            },
            handleTouchStart(e) { this.touchStartX = e.touches[0].clientX; },
            handleTouchEnd(e, product) {
                const deltaX = e.changedTouches[0].clientX - this.touchStartX;
                if (Math.abs(deltaX) > 40) {
                    if (!product.activeIdx) product.activeIdx = 0;
                    if (deltaX > 0) {
                        product.activeIdx = (product.activeIdx > 0) ? product.activeIdx - 1 : product.images.length - 1;
                    } else {
                        product.activeIdx = (product.activeIdx + 1) % product.images.length;
                    }
                    this.triggerHaptic();
                }
            },
            openProduct(p) {
                this.selectedProduct = p;
                this.fvIdx = 0;
                this.selectedSize = p.sizes[0] || '';
                this.triggerHaptic();
            },
            isFav(id) { return this.favorites.includes(id); },
            toggleFavorite(p) {
                const idx = this.favorites.indexOf(p.id);
                if (idx > -1) this.favorites.splice(idx, 1);
                else this.favorites.push(p.id);
                localStorage.setItem('naran_fav', JSON.stringify(this.favorites));
                this.triggerHaptic();
            },
            addToCart(p) {
                this.cart.push({
                    ...p,
                    selectedSize: this.selectedSize,
                    qty: 1
                });
                localStorage.setItem('naran_cart', JSON.stringify(this.cart));
                this.selectedProduct = null;
                this.triggerHaptic();
                tg.showScanQrPopup({ text: "–¢–û–í–ê–† –î–û–ë–ê–í–õ–ï–ù" }); setTimeout(() => tg.closeScanQrPopup(), 600);
            },
            updateQty(idx, delta) {
                this.cart[idx].qty += delta;
                if (this.cart[idx].qty < 1) this.cart.splice(idx, 1);
                localStorage.setItem('naran_cart', JSON.stringify(this.cart));
            },
            removeFromCart(idx) {
                this.cart.splice(idx, 1);
                localStorage.setItem('naran_cart', JSON.stringify(this.cart));
            },
            selectDelivery(type) {
                this.deliveryType = type;
                this.triggerHaptic();
                setTimeout(() => this.initMap(), 100);
            },
            initMap() {
                if (this.map) return;
                this.map = new mapgl.Map('map-container', {
                    center: [37.61, 55.75],
                    zoom: 12,
                    key: 'cab82c94-e619-42eb-9814-3361712feaf0'
                });
                this.map.on('click', e => this.getAddress(e.lngLat));
            },
            async getAddress(coords) {
                try {
                    const res = await fetch(`https://catalog.api.2gis.com/3.0/items/geocode?lon=${coords[0]}&lat=${coords[1]}&fields=items.address&key=cab82c94-e619-42eb-9814-3361712feaf0`);
                    const data = await res.json();
                    if (data.result?.items[0]) {
                        this.address = data.result.items[0].address_name || data.result.items[0].full_name;
                        localStorage.setItem('naran_last_addr', this.address);
                        if (this.marker) this.marker.destroy();
                        this.marker = new mapgl.Marker(this.map, { coordinates: coords });
                    }
                } catch(e) { console.error(e); }
            },
            async checkout() {
                if (!this.orderForm.phone || this.orderForm.phone.length < 10) return tg.showAlert("–í–í–ï–î–ò–¢–ï –ö–û–†–†–ï–ö–¢–ù–´–ô –ù–û–ú–ï–†");
                if (!this.address) return tg.showAlert("–í–´–ë–ï–†–ò–¢–ï –ê–î–†–ï–° –ù–ê –ö–ê–†–¢–ï");

                const orderId = `${new Date().toISOString().slice(0,10)}-${Math.floor(10000 + Math.random() * 90000)}`;
                const orderData = {
                    order_id: orderId,
                    uid: this.user.id,
                    phone: this.orderForm.phone,
                    total: this.totalPrice,
                    address: this.address,
                    delivery: this.deliveryType,
                    status: '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ',
                    items: this.cart,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection("orders").add(orderData);
                
                // –û—Ç–ø—Ä–∞–≤–∫–∞ –±–æ—Ç—É
                tg.sendData(JSON.stringify(orderData));

                tg.showAlert(`–ó–ê–ö–ê–ó ‚Ññ${orderId} –ü–†–ò–ù–Ø–¢!`);
                this.cart = [];
                localStorage.removeItem('naran_cart');
                this.currentTab = 'profile';
            },

            // ADMIN METHODS
            async uploadImages(e) {
                this.loading = true;
                try {
                    for (let file of e.target.files) {
                        const fd = new FormData();
                        fd.append('image', file);
                        const res = await fetch('https://api.imgbb.com/1/upload?key=839e62907e9a52f0159461b7771bcb2f', { method: 'POST', body: fd });
                        const data = await res.json();
                        if (data.success) this.newP.images.push(data.data.url);
                    }
                } catch(e) { tg.showAlert("–û–®–ò–ë–ö–ê –ó–ê–ì–†–£–ó–ö–ò –§–û–¢–û"); }
                this.loading = false;
            },
            async saveProduct() {
                const data = {
                    ...this.newP,
                    price: Number(this.newP.price),
                    oldPrice: Number(this.newP.oldPrice) || null,
                    sizes: String(this.newP.sizes).split(',').map(s => s.trim())
                };
                if (this.editMode) await db.collection("products").doc(this.editId).update(data);
                else await db.collection("products").add(data);
                this.resetForm();
            },
            editProduct(pr) {
                this.editMode = true;
                this.editId = pr.id;
                this.newP = { ...pr, sizes: pr.sizes.join(',') };
                window.scrollTo(0, 500);
            },
            async deleteProduct(id) {
                if (confirm("–£–î–ê–õ–ò–¢–¨ –¢–û–í–ê–†?")) await db.collection("products").doc(id).delete();
            },
            async toggleVisible(pr) {
                await db.collection("products").doc(pr.id).update({ hidden: !pr.hidden });
            },
            resetForm() {
                this.editMode = false;
                this.newP = { title: '', desc: '', price: '', oldPrice: '', category: '', sizes: '', images: [] };
            },
            async addCategory() {
                if (!this.newCatName) return;
                await db.collection("categories").add({ name: this.newCatName });
                this.newCatName = '';
            },
            async deleteCategory(id) {
                await db.collection("categories").doc(id).delete();
            },
            async updateOrderStatus(id, status) {
                await db.collection("orders").doc(id).update({ status });
            },
            printOrder(ord) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFont("Montserrat", "bold");
                doc.text(`ORDER NARAN: ${ord.order_id}`, 20, 20);
                doc.text(`PHONE: ${ord.phone}`, 20, 30);
                doc.text(`ADDRESS: ${ord.address}`, 20, 40);
                doc.text(`TOTAL: ${ord.total} RUB`, 20, 50);
                doc.save(`order_${ord.order_id}.pdf`);
            }
        },
        mounted() {
            tg.ready();
            tg.expand();
            
            this.isAdmin = false;
            if (tg.initDataUnsafe?.user) {
                this.user = tg.initDataUnsafe.user;
                this.isAdmin = Number(this.user.id) === this.adminId || String(this.user.id) === String(this.adminId);
                console.log("User ID:", this.user.id, "Is Admin:", this.isAdmin);
            }

            // Real-time Sync
            db.collection("products").onSnapshot(s => {
                this.products = s.docs.map(d => ({ id: d.id, activeIdx: 0, ...d.data() }));
            });
            db.collection("categories").onSnapshot(s => {
                this.categories = s.docs.map(d => ({ id: d.id, ...d.data() }));
            });
            db.collection("orders").onSnapshot(s => {
                this.orders = s.docs.map(d => ({ id: d.id, ...d.data() }));
            });
        }
    }).mount('#app');
</script>
</body>
</html>
