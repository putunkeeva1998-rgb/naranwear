<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NARAN PREMIUM</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://mapgl.2gis.com/api/js/v1"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --bg: #ffffff; 
            --text: #000000;
            --gray-light: #f4f4f4;
            --gray-mid: #999999;
            --accent: #000000;
            --red: #ff0000;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body { 
            margin: 0; 
            background: var(--bg); 
            font-family: 'Montserrat', sans-serif; 
            color: var(--text); 
            overflow-x: hidden; 
        }

        /* UI Elements */
        .btn-black { background: #000; color: #fff; border: none; padding: 15px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; border-radius: 2px; }
        .btn-outline { background: transparent; color: #000; border: 1px solid #000; padding: 10px; font-weight: 600; border-radius: 2px; }
        
        /* Header */
        .header { 
            background: #fff; padding: 15px; display: flex; align-items: center; justify-content: space-between;
            position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid #eee;
        }
        .brand-name { font-weight: 800; font-size: 20px; letter-spacing: 3px; }

        .search-bar { padding: 10px 15px; background: #fff; border-bottom: 1px solid #eee; display: flex; align-items: center; }
        .search-input { border: none; width: 100%; font-family: inherit; font-size: 14px; padding: 5px; }

        /* Catalog */
        .container { padding: 15px; padding-bottom: 100px; }
        .cat-row { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 15px; scrollbar-width: none; }
        .cat-row::-webkit-scrollbar { display: none; }
        .cat-item { 
            padding: 8px 18px; border: 1px solid #000; font-size: 10px; font-weight: 600; 
            text-transform: uppercase; white-space: nowrap; cursor: pointer;
        }
        .cat-item.active { background: #000; color: #fff; }

        /* Grid */
        .products-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .card { background: #fff; position: relative; display: flex; flex-direction: column; margin-bottom: 15px; }
        
        .slider-wrapper { position: relative; width: 100%; aspect-ratio: 3/4; overflow: hidden; background: #f9f9f9; }
        .slider-inner { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; scrollbar-width: none; height: 100%; }
        .slider-inner::-webkit-scrollbar { display: none; }
        .slider-inner img { width: 100%; height: 100%; object-fit: cover; scroll-snap-align: start; flex-shrink: 0; }
        
        .dots { position: absolute; bottom: 10px; width: 100%; display: flex; justify-content: center; gap: 4px; }
        .dot { width: 4px; height: 4px; background: rgba(0,0,0,0.2); border-radius: 50%; }
        .dot.active { background: #000; width: 12px; border-radius: 2px; }

        .card-info { padding: 10px 0; }
        .card-title { font-size: 11px; font-weight: 400; margin-bottom: 4px; text-transform: uppercase; height: 14px; overflow: hidden; }
        .card-price { font-weight: 800; font-size: 13px; }
        .old-price { text-decoration: line-through; color: #999; font-size: 11px; margin-left: 5px; }

        .card-actions { display: flex; gap: 5px; margin-top: 10px; }
        .action-fav { width: 40px; border: 1px solid #eee; background: #fff; display: flex; align-items: center; justify-content: center; }
        .action-cart { flex: 1; font-size: 10px; padding: 10px; }

        /* Bottom Nav */
        .bottom-nav { 
            position: fixed; bottom: 0; left: 0; right: 0; background: #fff; 
            display: flex; justify-content: space-around; padding: 10px 0 25px; 
            border-top: 1px solid #eee; z-index: 1000; 
        }
        .nav-item { border: none; background: none; color: #999; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 9px; font-weight: 600; position: relative; }
        .nav-item.active { color: #000; }
        .nav-item svg { width: 22px; height: 22px; }
        .badge { position: absolute; top: -5px; right: -5px; background: var(--red); color: #fff; font-size: 8px; padding: 2px 5px; border-radius: 10px; }

        /* Full View Modal */
        .full-view { position: fixed; inset: 0; background: #fff; z-index: 2000; overflow-y: auto; padding-bottom: 50px; }
        .close-btn { position: fixed; top: 20px; right: 20px; z-index: 2100; background: #000; color: #fff; width: 30px; height: 30px; border: none; border-radius: 50%; }
        
        .size-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 20px 0; }
        .size-box { border: 1px solid #eee; padding: 10px; text-align: center; font-size: 12px; cursor: pointer; }
        .size-box.active { border-color: #000; background: #000; color: #fff; }

        /* Map */
        #map { width: 100%; height: 300px; margin: 15px 0; border: 1px solid #000; }

        /* Burger Menu */
        .burger-content { position: fixed; inset: 0; background: #fff; z-index: 3000; padding: 40px 20px; }
        
        /* Admin */
        .admin-section { border: 1px solid #eee; padding: 15px; margin-bottom: 20px; border-radius: 4px; }
        .input-group { margin-bottom: 12px; }
        .input-group label { display: block; font-size: 10px; font-weight: 700; text-transform: uppercase; margin-bottom: 5px; }
        .input-std { width: 100%; padding: 12px; border: 1px solid #eee; font-family: inherit; }
    </style>
</head>
<body>

<div id="app">
    <header class="header">
        <button @click="menuOpen = true; vibrate()" style="background:none; border:none;">
            <svg viewBox="0 0 24 24" width="24" fill="none" stroke="black" stroke-width="1.5"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
        </button>
        <div class="brand-name" @click="activeTab = 'catalog'">NARAN</div>
        <button @click="showSearch = !showSearch; vibrate()" style="background:none; border:none;">
            <svg viewBox="0 0 24 24" width="22" fill="none" stroke="black" stroke-width="1.5"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        </button>
    </header>

    <div v-if="showSearch" class="search-bar">
        <input v-model="searchQuery" class="search-input" placeholder="–ü–û–ò–°–ö –¢–û–í–ê–†–ê..." autofocus>
    </div>

    <main class="container">
        
        <div v-if="activeTab === 'catalog'">
            <div class="cat-row">
                <div class="cat-item" :class="{active: currentCat === ''}" @click="currentCat = ''; vibrate()">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</div>
                <div v-for="cat in categories" :key="cat" class="cat-item" :class="{active: currentCat === cat}" @click="currentCat = cat; vibrate()">{{cat}}</div>
            </div>

            <div class="products-grid">
                <div v-for="p in filteredProducts" :key="p.id" class="card" @click="openProduct(p)">
                    <div class="slider-wrapper">
                        <div class="slider-inner" @scroll="e => handleScroll(e, p)">
                            <img v-for="img in p.images" :src="img">
                        </div>
                        <div class="dots">
                            <span v-for="(img, idx) in p.images" class="dot" :class="{active: idx === (p.aIdx || 0)}"></span>
                        </div>
                    </div>
                    <div class="card-info">
                        <div class="card-title">{{p.title}}</div>
                        <div class="card-price">
                            {{p.price}} ‚ÇΩ <span v-if="p.oldPrice" class="old-price">{{p.oldPrice}} ‚ÇΩ</span>
                        </div>
                        <div class="card-actions">
                            <button class="action-fav" @click.stop="toggleFav(p)">
                                <svg :fill="isFav(p) ? 'red' : 'none'" :stroke="isFav(p) ? 'red' : 'black'" viewBox="0 0 24 24" width="18"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                            </button>
                            <button class="btn-black action-cart" @click.stop="openProduct(p)">–í –ö–û–†–ó–ò–ù–£</button>
                        </div>
                    </div>
                </div>
            </div>
            <div v-if="filteredProducts.length === 0" style="text-align: center; margin-top: 50px; color: #999;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
        </div>

        <div v-if="activeTab === 'favs'">
            <h2 style="font-weight: 300; letter-spacing: 2px;">–ò–ó–ë–†–ê–ù–ù–û–ï</h2>
            <div v-if="favItems.length === 0" style="text-align:center; padding: 100px 0;">‚ù§Ô∏è –ó–¥–µ—Å—å –ø–æ–∫–∞ –ø—É—Å—Ç–æ</div>
            <div class="products-grid">
                <div v-for="p in favItems" :key="p.id" class="card" @click="openProduct(p)">
                    <img :src="p.img" style="width:100%; aspect-ratio:3/4; object-fit:cover;">
                    <div class="card-info">
                        <div class="card-title">{{p.title}}</div>
                        <div class="card-price">{{p.price}} ‚ÇΩ</div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="activeTab === 'cart'">
            <h2 style="font-weight: 300; letter-spacing: 2px;">–ö–û–†–ó–ò–ù–ê</h2>
            <div v-if="cart.length === 0" style="text-align:center; padding: 100px 0;">–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>
            <div v-else>
                <div v-for="(item, idx) in cart" :key="item.cartId" style="display: flex; gap: 15px; margin-bottom: 20px; border-bottom: 1px solid #f9f9f9; padding-bottom: 15px;">
                    <img :src="item.img" style="width: 80px; height: 100px; object-fit: cover;">
                    <div style="flex: 1;">
                        <div style="font-size: 12px; font-weight: 600;">{{item.title}}</div>
                        <div style="font-size: 10px; color: #999; margin: 5px 0;">–†–∞–∑–º–µ—Ä: {{item.selectedSize}} | –¶–≤–µ—Ç: {{item.selectedColor || '–°—Ç–∞–Ω–¥–∞—Ä—Ç'}}</div>
                        <div style="font-weight: 800;">{{item.price}} ‚ÇΩ</div>
                        <div style="display: flex; align-items: center; gap: 15px; margin-top: 10px;">
                            <button @click="updateQty(idx, -1)" style="border: 1px solid #eee; background: none; width: 25px;">-</button>
                            <span>{{item.qty || 1}}</span>
                            <button @click="updateQty(idx, 1)" style="border: 1px solid #eee; background: none; width: 25px;">+</button>
                        </div>
                    </div>
                    <button @click="removeFromCart(idx)" style="background: none; border: none; font-size: 18px;">‚úï</button>
                </div>

                <div style="margin-top: 30px; border-top: 2px solid #000; padding-top: 20px;">
                    <div class="input-group">
                        <label>–ò–º—è</label>
                        <input v-model="form.name" class="input-std" placeholder="–í–∞—à–µ –∏–º—è">
                    </div>
                    <div class="input-group">
                        <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
                        <input v-model="form.phone" class="input-std" type="tel" placeholder="79000000000">
                    </div>
                    
                    <label style="font-size: 10px; font-weight: 700;">–î–û–°–¢–ê–í–ö–ê</label>
                    <div style="display: flex; gap: 5px; margin: 10px 0;">
                        <button v-for="d in ['–°–î–≠–ö', '–ü–æ—á—Ç–∞', '5Post']" @click="setDelivery(d)" :class="['btn-outline', deliv === d ? 'active-btn' : '']" style="flex: 1; font-size: 10px;">
                            {{d}}
                        </button>
                    </div>

                    <div v-if="deliv">
                        <div style="font-size: 11px; margin: 10px 0; background: #f9f9f9; padding: 10px;">
                            üìç <b>{{address || '–í—ã–±–µ—Ä–∏—Ç–µ –ü–í–ó –Ω–∞ –∫–∞—Ä—Ç–µ'}}</b>
                        </div>
                        <div id="map"></div>
                    </div>

                    <button class="btn-black" style="width: 100%; margin-top: 20px;" @click="checkout" :disabled="!isFormValid">
                        –û–§–û–†–ú–ò–¢–¨ –ó–ê–ö–ê–ó ‚Äî {{total}} ‚ÇΩ
                    </button>
                </div>
            </div>
        </div>

        <div v-if="activeTab === 'profile'">
            <div style="text-align: center; margin-bottom: 30px;">
                <img :src="user.photo_url || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'" style="width: 80px; height: 80px; border-radius: 50%; border: 1px solid #eee; padding: 5px;">
                <h3 style="margin: 10px 0 5px;">{{user.first_name || '–ü–æ–∫—É–ø–∞—Ç–µ–ª—å'}}</h3>
                <button @click="tg.openTelegramLink('https://t.me/opttania')" class="btn-outline" style="font-size: 10px;">–ü–û–î–î–ï–†–ñ–ö–ê</button>
            </div>

            <div style="margin-bottom: 30px;">
                <h4 style="text-transform: uppercase; font-size: 12px; border-bottom: 1px solid #eee; padding-bottom: 5px;">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h4>
                <div v-if="myOrders.length === 0" style="color: #999; font-size: 12px; padding: 10px 0;">–ó–∞–∫–∞–∑–æ–≤ –µ—â–µ –Ω–µ—Ç</div>
                <div v-for="o in myOrders" :key="o.id" style="padding: 10px; background: #f9f9f9; margin-bottom: 5px; font-size: 11px;">
                    <div style="display: flex; justify-content: space-between;">
                        <b>‚Ññ {{o.order_id}}</b>
                        <span :style="{color: getStatusColor(o.status)}">{{o.status || '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ'}}</span>
                    </div>
                    <div>{{o.total}} ‚ÇΩ ‚Ä¢ {{new Date(o.createdAt?.seconds * 1000).toLocaleDateString()}}</div>
                </div>
            </div>

            <div v-if="isAdmin" style="border-top: 4px solid #000; padding-top: 20px;">
                <h2 style="text-align: center; letter-spacing: 5px;">ADMIN</h2>
                
                <div class="admin-section">
                    <h4>–ù–û–í–´–ô –¢–û–í–ê–†</h4>
                    <div class="input-group"><input v-model="newP.title" class="input-std" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"></div>
                    <div class="input-group"><textarea v-model="newP.desc" class="input-std" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea></div>
                    <div style="display: flex; gap: 10px;">
                        <input v-model.number="newP.price" class="input-std" placeholder="–¶–µ–Ω–∞">
                        <input v-model.number="newP.oldPrice" class="input-std" placeholder="–°—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞ (Sale)">
                    </div>
                    <div class="input-group">
                        <select v-model="newP.category" class="input-std">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                            <option v-for="cat in categories" :value="cat">{{cat}}</option>
                        </select>
                    </div>
                    <div class="input-group"><input v-model="newP.sizesInput" class="input-std" placeholder="–†–∞–∑–º–µ—Ä—ã (42, 44, 46)"></div>
                    <div class="input-group"><input v-model="newP.color" class="input-std" placeholder="–¶–≤–µ—Ç"></div>
                    
                    <div style="margin: 10px 0;">
                        <input type="file" multiple @change="handleFileUpload" id="fileInput" style="display:none">
                        <button class="btn-outline" style="width: 100%;" @click="triggerFiles" :disabled="uploading">
                            {{ uploading ? '–ó–ê–ì–†–£–ó–ö–ê...' : '–ó–ê–ì–†–£–ó–ò–¢–¨ –§–û–¢–û (ImgBB)' }}
                        </button>
                        <div style="display: flex; gap: 5px; margin-top: 5px; overflow-x: auto;">
                            <img v-for="url in newP.images" :src="url" style="width: 50px; height: 50px; object-fit: cover;">
                        </div>
                    </div>

                    <button class="btn-black" style="width: 100%;" @click="saveProduct">–°–û–•–†–ê–ù–ò–¢–¨ –¢–û–í–ê–†</button>
                </div>

                <div class="admin-section">
                    <h4>–ó–ê–ö–ê–ó–´ ({{orders.length}}) | –í—ã—Ä—É—á–∫–∞: {{revenue}} ‚ÇΩ</h4>
                    <div v-for="order in orders" :key="order.id" style="border: 1px solid #eee; padding: 10px; margin-bottom: 10px; font-size: 11px;">
                        <div><b>{{order.order_id}}</b> - {{order.user?.name}}</div>
                        <div>{{order.total}} ‚ÇΩ | {{order.delivery}}</div>
                        <select @change="updateOrderStatus(order.id, $event.target.value)" :value="order.status || '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ'" class="input-std" style="margin-top: 5px; padding: 5px;">
                            <option>–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</option>
                            <option>–û–ø–ª–∞—á–µ–Ω–æ</option>
                            <option>–í –ø—É—Ç–∏</option>
                            <option>–ì–æ—Ç–æ–≤</option>
                            <option>–û—Ç–º–µ–Ω–µ–Ω</option>
                        </select>
                    </div>
                </div>

                <div class="admin-section">
                    <h4>–¢–û–í–ê–†–´ ({{products.length}})</h4>
                    <div v-for="p in products" :key="p.id" style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                        <img :src="p.img" style="width: 40px; height: 40px; object-fit: cover;">
                        <div style="flex: 1; font-size: 10px;">{{p.title}}</div>
                        <button @click="toggleProductStatus(p)" class="btn-outline" style="font-size: 8px;">{{ p.hidden ? '–ü–û–ö–ê–ó–ê–¢–¨' : '–°–ö–†–´–¢–¨' }}</button>
                        <button @click="deleteProduct(p.id)" style="color: red; border: none; background: none;">‚úï</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div v-if="selP" class="full-view">
        <button class="close-btn" @click="selP = null">‚úï</button>
        <div class="slider-wrapper" style="aspect-ratio: 1/1;">
            <div class="slider-inner" @scroll="e => handleScroll(e, selP)">
                <img v-for="img in selP.images" :src="img">
            </div>
            <div class="dots">
                <span v-for="(img, idx) in selP.images" class="dot" :class="{active: idx === (selP.aIdx || 0)}"></span>
            </div>
        </div>
        <div style="padding: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <h1 style="font-size: 18px; text-transform: uppercase; margin: 0;">{{selP.title}}</h1>
                <div style="text-align: right;">
                    <div style="font-size: 20px; font-weight: 800;">{{selP.price}} ‚ÇΩ</div>
                    <div v-if="selP.oldPrice" style="text-decoration: line-through; color: #999;">{{selP.oldPrice}} ‚ÇΩ</div>
                </div>
            </div>
            
            <p style="font-size: 13px; line-height: 1.6; color: #666; margin: 20px 0;">{{selP.desc}}</p>

            <div style="margin: 20px 0;">
                <label style="font-size: 10px; font-weight: 800;">–í–´–ë–ï–†–ò–¢–ï –†–ê–ó–ú–ï–†</label>
                <div class="size-grid">
                    <div v-for="s in selP.sizes" :key="s" class="size-box" :class="{active: selP.selectedSize === s}" @click="selP.selectedSize = s; vibrate()">
                        {{s}}
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 10px;">
                <button class="action-fav btn-outline" style="width: 60px; height: 50px;" @click="toggleFav(selP)">
                    <svg :fill="isFav(selP) ? 'red' : 'none'" :stroke="isFav(selP) ? 'red' : 'black'" viewBox="0 0 24 24" width="24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                </button>
                <button class="btn-black" style="flex: 1; height: 50px;" @click="addToCart(selP)">–î–û–ë–ê–í–ò–¢–¨ –í –ö–û–†–ó–ò–ù–£</button>
            </div>
        </div>
    </div>

    <div v-if="menuOpen" class="burger-content">
        <button @click="menuOpen = false" style="float: right; background: none; border: none; font-size: 24px;">‚úï</button>
        <h2 class="brand-name" style="margin-bottom: 40px;">NARAN</h2>
        <div style="display: flex; flex-direction: column; gap: 30px; font-size: 18px; font-weight: 300; text-transform: uppercase; letter-spacing: 2px;">
            <div @click="openInfo('about')">–û –Ω–∞—Å</div>
            <div @click="openInfo('delivery')">–î–æ—Å—Ç–∞–≤–∫–∞</div>
            <div @click="openInfo('returns')">–í–æ–∑–≤—Ä–∞—Ç</div>
        </div>
    </div>

    <nav class="bottom-nav">
        <button @click="activeTab = 'catalog'; vibrate()" :class="['nav-item', activeTab === 'catalog' ? 'active' : '']">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
            <span>–ö–ê–¢–ê–õ–û–ì</span>
        </button>
        <button @click="activeTab = 'favs'; vibrate()" :class="['nav-item', activeTab === 'favs' ? 'active' : '']">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
            <span>–ò–ó–ë–†–ê–ù–ù–û–ï</span>
        </button>
        <button @click="activeTab = 'cart'; vibrate()" :class="['nav-item', activeTab === 'cart' ? 'active' : '']">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg>
            <span v-if="cart.length > 0" class="badge">{{cart.length}}</span>
            <span>–ö–û–†–ó–ò–ù–ê</span>
        </button>
        <button @click="activeTab = 'profile'; vibrate()" :class="['nav-item', activeTab === 'profile' ? 'active' : '']">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            <span>–ü–†–û–§–ò–õ–¨</span>
        </button>
    </nav>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC6fihIMtOYZuPh-db3Tc6eiRgSikzydVw",
        authDomain: "naran-80077.firebaseapp.com",
        projectId: "naran-80077",
        storageBucket: "naran-80077.firebasestorage.app",
        messagingSenderId: "901156477154",
        appId: "IG-PR8PLCMF3C"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const { createApp } = Vue;
    const tg = window.Telegram.WebApp;

    createApp({
        data() {
            return {
                tg,
                activeTab: 'catalog',
                products: [],
                orders: [],
                myOrders: [],
                categories: ['–ø–∏–¥–∂–∞–∫–∏', '—Å–≤–∏—Ç–µ—Ä—ã', '–∫–∞—Ä–¥–∏–≥–∞–Ω—ã', '–∫–æ—Å—Ç—é–º—ã', '–ª–æ–Ω–≥—Å–ª–∏–≤—ã', '—Ñ—É—Ç–±–æ–ª–∫–∏', '–∫–æ—Ä—Å–µ—Ç—ã', '–∫—É—Ä—Ç–∫–∏', '—ç–∫–æ—à—É–±—ã'],
                currentCat: '',
                searchQuery: '',
                showSearch: false,
                menuOpen: false,
                uploading: false,
                isAdmin: false,
                adminId: 387881523,
                user: {},
                cart: JSON.parse(localStorage.getItem('naran_cart') || '[]'),
                favorites: JSON.parse(localStorage.getItem('naran_favs') || '[]'),
                selP: null,
                deliv: '',
                address: localStorage.getItem('naran_last_address') || '',
                form: { name: '', phone: localStorage.getItem('naran_phone') || '' },
                newP: { title: '', desc: '', price: '', oldPrice: '', category: '', images: [], sizesInput: '42, 44, 46', color: '' },
                map: null,
                markers: []
            }
        },
        computed: {
            filteredProducts() {
                try {
                    return this.products.filter(p => {
                        const matchCat = this.currentCat === '' || p.category === this.currentCat;
                        const matchSearch = p.title.toLowerCase().includes(this.searchQuery.toLowerCase());
                        const matchHidden = this.isAdmin || !p.hidden;
                        return matchCat && matchSearch && matchHidden;
                    });
                } catch(e) { return []; }
            },
            favItems() {
                return this.products.filter(p => this.favorites.includes(p.id));
            },
            total() {
                return this.cart.reduce((s, i) => s + (i.price * (i.qty || 1)), 0);
            },
            isFormValid() {
                return this.form.name.length > 1 && /^\d{10,11}$/.test(this.form.phone) && this.address;
            },
            revenue() {
                return this.orders.reduce((s, o) => s + (Number(o.total) || 0), 0);
            }
        },
        methods: {
            vibrate() { tg.HapticFeedback.impactOccurred('medium'); },
            handleScroll(e, p) { 
                p.aIdx = Math.round(e.target.scrollLeft / e.target.offsetWidth); 
            },
            openProduct(p) {
                this.vibrate();
                this.selP = { ...p, selectedSize: p.sizes ? p.sizes[0] : '' };
            },
            toggleFav(p) {
                this.vibrate();
                const idx = this.favorites.indexOf(p.id);
                if (idx > -1) this.favorites.splice(idx, 1);
                else this.favorites.push(p.id);
                localStorage.setItem('naran_favs', JSON.stringify(this.favorites));
            },
            isFav(p) { return this.favorites.includes(p.id); },
            addToCart(p) {
                if (!p.selectedSize) return tg.showAlert("–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–º–µ—Ä");
                const item = { ...p, cartId: Date.now(), qty: 1 };
                this.cart.push(item);
                localStorage.setItem('naran_cart', JSON.stringify(this.cart));
                this.selP = null;
                tg.HapticFeedback.notificationOccurred('success');
            },
            removeFromCart(idx) {
                this.cart.splice(idx, 1);
                localStorage.setItem('naran_cart', JSON.stringify(this.cart));
            },
            updateQty(idx, val) {
                const item = this.cart[idx];
                item.qty = Math.max(1, (item.qty || 1) + val);
                localStorage.setItem('naran_cart', JSON.stringify(this.cart));
            },
            setDelivery(d) {
                this.deliv = d;
                this.vibrate();
                this.$nextTick(() => this.initMap());
            },
            initMap() {
                if (this.map) { this.map.destroy(); }
                this.map = new mapgl.Map('map', {
                    center: [37.6175, 55.7558],
                    zoom: 12,
                    key: 'cab82c94-e619-42eb-9814-3361712feaf0'
                });
                
                this.map.on('click', (e) => {
                    const [lon, lat] = e.lngLat;
                    this.fetchAddress(lat, lon);
                });

                navigator.geolocation.getCurrentPosition(p => {
                    this.map.setCenter([p.coords.longitude, p.coords.latitude]);
                    this.fetchAddress(p.coords.latitude, p.coords.longitude);
                });
            },
            fetchAddress(lat, lon) {
                fetch(`https://catalog.api.2gis.com/3.0/items/geocode?lat=${lat}&lon=${lon}&fields=items.address&key=cab82c94-e619-42eb-9814-3361712feaf0`)
                .then(r => r.json())
                .then(d => {
                    if (d.result?.items?.length > 0) {
                        this.address = d.result.items[0].address_name || d.result.items[0].name;
                        localStorage.setItem('naran_last_address', this.address);
                    }
                });
            },
            async triggerFiles() { document.getElementById('fileInput').click(); },
            async handleFileUpload(e) {
                const files = e.target.files;
                this.uploading = true;
                for (let file of files) {
                    const formData = new FormData();
                    formData.append('image', file);
                    try {
                        const res = await fetch('https://api.imgbb.com/1/upload?key=839e62907e9a52f0159461b7771bcb2f', { method: 'POST', body: formData });
                        const data = await res.json();
                        if (data.success) this.newP.images.push(data.data.url);
                    } catch (err) { tg.showAlert("–û—à–∏–±–∫–∞ ImgBB"); }
                }
                this.uploading = false;
            },
            async saveProduct() {
                if (!this.newP.title || this.newP.images.length === 0) return tg.showAlert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ");
                try {
                    const data = {
                        ...this.newP,
                        price: Number(this.newP.price),
                        oldPrice: Number(this.newP.oldPrice) || null,
                        sizes: this.newP.sizesInput.split(',').map(s => s.trim()),
                        img: this.newP.images[0],
                        hidden: false,
                        createdAt: serverTimestamp()
                    };
                    await addDoc(collection(db, "products"), data);
                    tg.showAlert("–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω");
                    this.newP = { title: '', desc: '', price: '', images: [], sizesInput: '42, 44, 46' };
                } catch(e) { tg.showAlert(e.message); }
            },
            async checkout() {
                this.vibrate();
                const orderId = `${new Date().toISOString().slice(0,10).replace(/-/g,'')}-${Math.floor(10000+Math.random()*89999)}`;
                const orderData = {
                    order_id: orderId,
                    user: this.form,
                    user_id: this.user.id || 'guest',
                    cart: this.cart.map(i => ({ title: i.title, size: i.selectedSize, price: i.price, qty: i.qty })),
                    total: this.total,
                    delivery: this.deliv,
                    address: this.address,
                    status: '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ',
                    createdAt: serverTimestamp()
                };

                try {
                    await addDoc(collection(db, "orders"), orderData);
                    localStorage.setItem('naran_phone', this.form.phone);
                    
                    // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç—É
                    tg.sendData(JSON.stringify(orderData));
                    
                    this.cart = [];
                    localStorage.removeItem('naran_cart');
                    tg.showAlert(`–ó–∞–∫–∞–∑ ‚Ññ${orderId} –æ—Ñ–æ—Ä–º–ª–µ–Ω!`);
                    this.activeTab = 'profile';
                } catch(e) { tg.showAlert("–û—à–∏–±–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è"); }
            },
            getStatusColor(s) {
                const colors = { '–í –ø—É—Ç–∏': 'blue', '–ì–æ—Ç–æ–≤': 'green', '–û—Ç–º–µ–Ω–µ–Ω': 'red' };
                return colors[s] || 'orange';
            },
            async updateOrderStatus(id, status) {
                await updateDoc(doc(db, "orders", id), { status });
            },
            async toggleProductStatus(p) {
                await updateDoc(doc(db, "products", p.id), { hidden: !p.hidden });
            },
            async deleteProduct(id) {
                if (confirm("–£–¥–∞–ª–∏—Ç—å?")) await deleteDoc(doc(db, "products", id));
            },
            openInfo(type) {
                const info = {
                    about: "NARAN ‚Äî –ø—Ä–µ–º–∏–∞–ª—å–Ω—ã–π –±—Ä–µ–Ω–¥ –æ–¥–µ–∂–¥—ã. –ú—ã —Å–æ–∑–¥–∞–µ–º –∫–∞—á–µ—Å—Ç–≤–æ, –¥–æ—Å—Ç—É–ø–Ω–æ–µ –∫–∞–∂–¥–æ–º—É.",
                    delivery: "–î–æ—Å—Ç–∞–≤–∫–∞ –°–î–≠–ö, –ü–æ—á—Ç–∞ –†–æ—Å—Å–∏–∏ –∏ 5Post. –°—Ä–æ–∫ 2-10 –¥–Ω–µ–π.",
                    returns: "–í–æ–∑–≤—Ä–∞—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 14 –¥–Ω–µ–π –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –±–∏—Ä–æ–∫ –∏ —Ç–æ–≤–∞—Ä–Ω–æ–≥–æ –≤–∏–¥–∞."
                };
                tg.showAlert(info[type]);
            }
        },
        mounted() {
            tg.ready();
            tg.expand();
            if (tg.initDataUnsafe?.user) {
                this.user = tg.initDataUnsafe.user;
                if (this.user.id == this.adminId) this.isAdmin = true;
            }

            // –°–ª—É—à–∞—Ç–µ–ª—å —Ç–æ–≤–∞—Ä–æ–≤
            onSnapshot(query(collection(db, "products"), orderBy("createdAt", "desc")), (s) => {
                this.products = s.docs.map(d => ({ id: d.id, ...d.data(), aIdx: 0 }));
            });

            // –°–ª—É—à–∞—Ç–µ–ª—å –∑–∞–∫–∞–∑–æ–≤ (–¥–ª—è –∞–¥–º–∏–Ω–∞)
            if (this.isAdmin) {
                onSnapshot(collection(db, "orders"), (s) => {
                    this.orders = s.docs.map(d => ({ id: d.id, ...d.data() }));
                });
            }

            // –°–ª—É—à–∞—Ç–µ–ª—å –ª–∏—á–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤
            if (this.user.id) {
                const q = query(collection(db, "orders"), where("user_id", "==", this.user.id));
                onSnapshot(q, (s) => {
                    this.myOrders = s.docs.map(d => ({ id: d.id, ...d.data() }));
                });
            }
        }
    }).mount('#app');
</script>

</body>
</html>
