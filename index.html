<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NARAN PREMIUM</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://mapgl.2gis.com/api/js/v1"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --bg: #ffffff; 
            --text: #000000;
            --gray-light: #f4f4f4;
            --accent: #000000;
            --red: #ff0000;
            --border: #eeeeee;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; background: var(--bg); font-family: 'Montserrat', sans-serif; color: var(--text); overflow-x: hidden; }

        /* –≠–ª–µ–º–µ–Ω—Ç—ã UI */
        .btn-black { background: #000; color: #fff; border: none; padding: 15px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; border-radius: 2px; width: 100%; transition: 0.2s; }
        .btn-black:active { opacity: 0.7; }
        .btn-outline { background: transparent; color: #000; border: 1px solid #000; padding: 10px; font-weight: 600; border-radius: 2px; cursor: pointer; text-transform: uppercase; font-size: 10px; }
        
        /* –®–∞–ø–∫–∞ */
        .header { 
            background: #fff; padding: 15px; display: flex; align-items: center; justify-content: space-between;
            position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid var(--border);
        }
        .brand-name { font-weight: 800; font-size: 20px; letter-spacing: 3px; cursor: pointer; text-transform: uppercase; }

        .search-bar { padding: 10px 15px; background: #fff; border-bottom: 1px solid var(--border); display: flex; align-items: center; }
        .search-input { border: none; width: 100%; font-family: inherit; font-size: 14px; padding: 5px; outline: none; text-transform: uppercase; }

        /* –ö–∞—Ç–∞–ª–æ–≥ */
        .container { padding: 15px; padding-bottom: 120px; min-height: 100vh; }
        .cat-row { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 15px; scrollbar-width: none; }
        .cat-row::-webkit-scrollbar { display: none; }
        .cat-item { 
            padding: 10px 20px; border: 1px solid #000; font-size: 10px; font-weight: 600; 
            text-transform: uppercase; white-space: nowrap; cursor: pointer; border-radius: 2px;
        }
        .cat-item.active { background: #000; color: #fff; }

        /* –°–µ—Ç–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ */
        .products-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .card { background: #fff; position: relative; display: flex; flex-direction: column; cursor: pointer; }
        
        .slider-wrapper { position: relative; width: 100%; aspect-ratio: 3/4; overflow: hidden; background: #f9f9f9; }
        .slider-inner { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; scrollbar-width: none; height: 100%; }
        .slider-inner::-webkit-scrollbar { display: none; }
        .slider-inner img { width: 100%; height: 100%; object-fit: cover; scroll-snap-align: start; flex-shrink: 0; }
        
        .dots { position: absolute; bottom: 8px; width: 100%; display: flex; justify-content: center; gap: 4px; pointer-events: none; }
        .dot { width: 4px; height: 4px; background: rgba(0,0,0,0.2); border-radius: 50%; transition: 0.3s; }
        .dot.active { background: #000; width: 10px; border-radius: 2px; }

        .card-info { padding: 8px 0; }
        .card-title { font-size: 11px; font-weight: 400; text-transform: uppercase; margin-bottom: 4px; height: 14px; overflow: hidden; }
        .card-price { font-weight: 800; font-size: 13px; }
        .old-price { text-decoration: line-through; color: #999; font-size: 11px; margin-left: 5px; }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .bottom-nav { 
            position: fixed; bottom: 0; left: 0; right: 0; background: #fff; 
            display: flex; justify-content: space-around; padding: 12px 0 25px; 
            border-top: 1px solid var(--border); z-index: 1000; 
        }
        .nav-item { border: none; background: none; color: #999; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 9px; font-weight: 600; position: relative; cursor: pointer; }
        .nav-item.active { color: #000; }
        .nav-item svg { width: 22px; height: 22px; }
        .badge { position: absolute; top: -5px; right: -5px; background: var(--red); color: #fff; font-size: 8px; padding: 2px 5px; border-radius: 10px; font-weight: 800; }

        /* Full View */
        .screen-view { position: fixed; inset: 0; background: #fff; z-index: 2000; overflow-y: auto; padding-bottom: 80px; }
        .close-screen { position: fixed; top: 20px; right: 20px; z-index: 2100; background: #000; color: #fff; width: 35px; height: 35px; border: none; border-radius: 50%; font-size: 18px; display: flex; align-items: center; justify-content: center; }
        
        .size-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 15px 0; }
        .size-box { border: 1px solid #eee; padding: 12px; text-align: center; font-size: 12px; cursor: pointer; transition: 0.2s; font-weight: 600; }
        .size-box.active { border-color: #000; background: #000; color: #fff; }

        /* –ö–∞—Ä—Ç–∞ */
        #map { width: 100%; height: 300px; margin: 15px 0; border: 1px solid #000; }

        /* –ê–¥–º–∏–Ω–∫–∞ */
        .admin-panel { background: #fff; border-top: 2px solid #000; padding: 15px; margin-top: 30px; }
        .admin-section { margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 10px; font-weight: 800; text-transform: uppercase; margin-bottom: 6px; }
        .input-std { width: 100%; padding: 12px; border: 1px solid #000; font-family: 'Montserrat'; font-size: 14px; border-radius: 0; }
        
        .order-card { border: 1px solid #eee; padding: 15px; margin-bottom: 10px; font-size: 12px; }
        .status-tag { padding: 4px 8px; font-size: 9px; font-weight: 800; text-transform: uppercase; color: #fff; }

        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body>

<div id="app">
    <header class="header">
        <button @click="activeTab = 'info'; vibrate()" style="background:none; border:none; padding: 5px;">
            <svg viewBox="0 0 24 24" width="24" fill="none" stroke="black" stroke-width="1.5"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
        </button>
        <div class="brand-name" @click="activeTab = 'catalog'; vibrate()">NARAN</div>
        <button @click="showSearch = !showSearch; vibrate()" style="background:none; border:none; padding: 5px;">
            <svg viewBox="0 0 24 24" width="22" fill="none" stroke="black" stroke-width="1.5"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        </button>
    </header>

    <div v-if="showSearch" class="search-bar">
        <input v-model="searchQuery" class="search-input" placeholder="–ü–û–ò–°–ö –ü–û –ù–ê–ó–í–ê–ù–ò–Æ..." autofocus>
    </div>

    <main class="container">
        
        <div v-if="activeTab === 'catalog'">
            <div class="cat-row">
                <div class="cat-item" :class="{active: currentCat === ''}" @click="currentCat = ''; vibrate()">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</div>
                <div v-for="cat in categories" :key="cat" class="cat-item" :class="{active: currentCat === cat}" @click="currentCat = cat; vibrate()">{{cat}}</div>
            </div>

            <div class="products-grid">
                <div v-for="p in filteredProducts" :key="p.id" class="card" @click="openProduct(p)">
                    <div class="slider-wrapper">
                        <div class="slider-inner" @scroll="e => handleScroll(e, p)">
                            <img v-for="img in p.images" :src="img" loading="lazy">
                        </div>
                        <div class="dots" v-if="p.images?.length > 1">
                            <span v-for="(img, idx) in p.images" class="dot" :class="{active: idx === (p.aIdx || 0)}"></span>
                        </div>
                    </div>
                    <div class="card-info">
                        <div class="card-title">{{p.title}}</div>
                        <div class="card-price">
                            {{p.price}} ‚ÇΩ <span v-if="p.oldPrice" class="old-price">{{p.oldPrice}} ‚ÇΩ</span>
                        </div>
                    </div>
                </div>
            </div>
            <div v-if="filteredProducts.length === 0" style="text-align: center; padding: 50px; color: #999; font-size: 12px;">–¢–û–í–ê–†–´ –ù–ï –ù–ê–ô–î–ï–ù–´</div>
        </div>

        <div v-if="activeTab === 'info'">
            <h2 style="letter-spacing: 2px; font-weight: 300; text-align: center;">–ò–ù–§–û–†–ú–ê–¶–ò–Ø</h2>
            <div style="display: flex; flex-direction: column; gap: 15px; margin-top: 30px;">
                <div @click="showInfo('about')" class="btn-outline" style="text-align: center; padding: 20px;">–û –ù–ê–°</div>
                <div @click="showInfo('delivery')" class="btn-outline" style="text-align: center; padding: 20px;">–î–û–°–¢–ê–í–ö–ê</div>
                <div @click="showInfo('returns')" class="btn-outline" style="text-align: center; padding: 20px;">–í–û–ó–í–†–ê–¢</div>
                <button class="btn-black" style="margin-top: 20px;" @click="activeTab = 'catalog'">–ù–ê–ó–ê–î –í –ö–ê–¢–ê–õ–û–ì</button>
            </div>
        </div>

        <div v-if="activeTab === 'favs'">
            <h2 style="font-weight: 300; letter-spacing: 2px; text-align: center;">–ò–ó–ë–†–ê–ù–ù–û–ï</h2>
            <div v-if="favItems.length === 0" style="text-align:center; padding: 100px 0; color: #999; font-size: 12px;">–í–ê–® –°–ü–ò–°–û–ö –ü–£–°–¢</div>
            <div class="products-grid">
                <div v-for="p in favItems" :key="p.id" class="card" @click="openProduct(p)">
                    <img :src="p.img" style="width:100%; aspect-ratio:3/4; object-fit:cover;">
                    <div class="card-info">
                        <div class="card-title">{{p.title}}</div>
                        <div class="card-price">{{p.price}} ‚ÇΩ</div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="activeTab === 'cart'">
            <h2 style="font-weight: 300; letter-spacing: 2px; text-align: center;">–ö–û–†–ó–ò–ù–ê</h2>
            <div v-if="cart.length === 0" style="text-align:center; padding: 100px 0; color: #999; font-size: 12px;">–ö–û–†–ó–ò–ù–ê –ü–£–°–¢–ê</div>
            <div v-else>
                <div v-for="(item, idx) in cart" :key="item.cartId" style="display: flex; gap: 15px; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px;">
                    <img :src="item.img" style="width: 80px; height: 100px; object-fit: cover;">
                    <div style="flex: 1;">
                        <div style="font-size: 11px; font-weight: 700; text-transform: uppercase;">{{item.title}}</div>
                        <div style="font-size: 10px; color: #666; margin: 4px 0;">–†–ê–ó–ú–ï–†: {{item.selectedSize}}</div>
                        <div style="font-weight: 800;">{{item.price}} ‚ÇΩ</div>
                        <div style="display: flex; align-items: center; gap: 15px; margin-top: 10px;">
                            <button @click="updateQty(idx, -1)" style="border: 1px solid #000; background: none; width: 30px; height: 30px;">-</button>
                            <span style="font-weight: 800;">{{item.qty}}</span>
                            <button @click="updateQty(idx, 1)" style="border: 1px solid #000; background: none; width: 30px; height: 30px;">+</button>
                        </div>
                    </div>
                    <button @click="removeFromCart(idx)" style="background: none; border: none; font-size: 20px;">‚úï</button>
                </div>

                <div style="margin-top: 30px; background: #fafafa; padding: 20px;">
                    <h4 style="margin-top: 0; letter-spacing: 1px;">–û–§–û–†–ú–õ–ï–ù–ò–ï –ó–ê–ö–ê–ó–ê</h4>
                    <div class="input-group">
                        <label>–í–ê–®–ï –ò–ú–Ø</label>
                        <input v-model="form.name" class="input-std" placeholder="–ò–í–ê–ù –ò–í–ê–ù–û–í">
                    </div>
                    <div class="input-group">
                        <label>–¢–ï–õ–ï–§–û–ù</label>
                        <input v-model="form.phone" class="input-std" type="tel" placeholder="79000000000">
                    </div>
                    
                    <label style="font-size: 10px; font-weight: 800;">–°–ü–û–°–û–ë –î–û–°–¢–ê–í–ö–ò</label>
                    <div style="display: flex; gap: 8px; margin: 10px 0;">
                        <button v-for="d in ['–°–î–≠–ö', '–ü–û–ß–¢–ê', '5POST']" @click="setDelivery(d)" :class="['btn-outline', deliv === d ? 'active' : '']" style="flex: 1;" :style="deliv === d ? 'background:#000;color:#fff':''">
                            {{d}}
                        </button>
                    </div>

                    <div v-if="deliv">
                        <div style="font-size: 10px; margin: 10px 0; background: #000; color: #fff; padding: 12px; font-weight: 600;">
                            üìç {{address || '–í–´–ë–ï–†–ò–¢–ï –ü–£–ù–ö–¢ –ù–ê –ö–ê–†–¢–ï'}}
                        </div>
                        <div id="map"></div>
                    </div>

                    <button class="btn-black" style="margin-top: 20px;" @click="checkout" :disabled="!isFormValid">
                        –û–§–û–†–ú–ò–¢–¨ ‚Äî {{total}} ‚ÇΩ
                    </button>
                </div>
            </div>
        </div>

        <div v-if="activeTab === 'profile'">
            <div style="text-align: center; margin-bottom: 30px; padding: 20px;">
                <img :src="user.photo_url || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'" style="width: 80px; height: 80px; border-radius: 50%; border: 1px solid #000; padding: 4px;">
                <h3 style="margin: 15px 0 5px; text-transform: uppercase; letter-spacing: 1px;">{{user.first_name || '–ü–û–ö–£–ü–ê–¢–ï–õ–¨'}}</h3>
                <button @click="tg.openTelegramLink('https://t.me/opttania')" class="btn-outline" style="margin-top: 10px;">–ü–û–î–î–ï–†–ñ–ö–ê</button>
            </div>

            <div style="margin-bottom: 40px;">
                <h4 style="text-transform: uppercase; font-size: 11px; border-bottom: 1px solid #000; padding-bottom: 8px; letter-spacing: 1px;">–ú–û–ò –ó–ê–ö–ê–ó–´</h4>
                <div v-if="myOrders.length === 0" style="color: #999; font-size: 11px; padding: 30px 0; text-align: center;">–£ –í–ê–° –ù–ï–¢ –ê–ö–¢–ò–í–ù–´–• –ó–ê–ö–ê–ó–û–í</div>
                <div v-for="o in myOrders" :key="o.id" class="order-card">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <b>‚Ññ {{o.order_id}}</b>
                        <span class="status-tag" :style="{background: getStatusColor(o.status)}">{{o.status}}</span>
                    </div>
                    <div style="color: #666; margin-top: 8px;">{{o.total}} ‚ÇΩ ‚Ä¢ {{o.cart?.length}} –¢–û–í.</div>
                </div>
            </div>

            <div v-if="isAdmin" class="admin-panel">
                <h2 style="text-align: center; letter-spacing: 4px; font-weight: 800; font-size: 16px; margin-bottom: 25px;">ADMIN PANEL</h2>
                
                <div class="admin-section">
                    <h4 style="font-size: 12px;">–ù–û–í–´–ô –¢–û–í–ê–†</h4>
                    <div class="input-group"><label>–ù–ê–ó–í–ê–ù–ò–ï</label><input v-model="newP.title" class="input-std"></div>
                    <div class="input-group"><label>–û–ü–ò–°–ê–ù–ò–ï</label><textarea v-model="newP.desc" class="input-std" rows="3"></textarea></div>
                    <div style="display: flex; gap: 10px;">
                        <div class="input-group" style="flex:1"><label>–¶–ï–ù–ê</label><input v-model.number="newP.price" class="input-std"></div>
                        <div class="input-group" style="flex:1"><label>SALE –¶–ï–ù–ê</label><input v-model.number="newP.oldPrice" class="input-std"></div>
                    </div>
                    <div class="input-group">
                        <label>–ö–ê–¢–ï–ì–û–†–ò–Ø</label>
                        <select v-model="newP.category" class="input-std">
                            <option v-for="cat in categories" :value="cat">{{cat}}</option>
                        </select>
                    </div>
                    <div class="input-group"><label>–†–ê–ó–ú–ï–†–´ (–ß–ï–†–ï–ó –ó–ê–ü–Ø–¢–£–Æ)</label><input v-model="newP.sizesInput" class="input-std"></div>
                    
                    <div style="margin: 15px 0;">
                        <input type="file" multiple @change="handleFileUpload" id="fileInput" style="display:none">
                        <button class="btn-outline" style="width: 100%; border-style: dashed;" @click="triggerFiles" :disabled="uploading">
                            {{ uploading ? '–ó–ê–ì–†–£–ó–ö–ê...' : '+ –í–´–ë–†–ê–¢–¨ –§–û–¢–û' }}
                        </button>
                        <div style="display: flex; gap: 8px; margin-top: 12px; overflow-x: auto;">
                            <img v-for="(url, idx) in newP.images" :key="idx" :src="url" style="width: 60px; height: 80px; object-fit: cover; border: 1px solid #000;">
                        </div>
                    </div>
                    <button class="btn-black" @click="saveProduct">–û–ü–£–ë–õ–ò–ö–û–í–ê–¢–¨</button>
                </div>

                <div class="admin-section">
                    <h4 style="font-size: 12px;">–ó–ê–ö–ê–ó–´ (–í–°–ï)</h4>
                    <div v-for="order in orders" :key="order.id" class="order-card">
                        <div style="display: flex; justify-content: space-between;">
                            <b>{{order.order_id}}</b>
                            <span>{{order.total}} ‚ÇΩ</span>
                        </div>
                        <div style="margin: 8px 0; font-size: 10px;">{{order.user?.name}} | {{order.user?.phone}}</div>
                        <select @change="updateOrderStatus(order.id, $event.target.value)" :value="order.status" class="input-std" style="padding: 5px; font-size: 10px;">
                            <option>–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</option>
                            <option>–û–ø–ª–∞—á–µ–Ω–æ</option>
                            <option>–í –ø—É—Ç–∏</option>
                            <option>–ì–æ—Ç–æ–≤</option>
                        </select>
                    </div>
                </div>

                <div class="admin-section">
                    <h4 style="font-size: 12px;">–¢–û–í–ê–†–´ ({{products.length}})</h4>
                    <div v-for="p in products" :key="p.id" style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                        <img :src="p.img" style="width: 45px; height: 60px; object-fit: cover;">
                        <div style="flex: 1; font-size: 10px;">
                            <b>{{p.title}}</b><br>{{p.price}} ‚ÇΩ
                        </div>
                        <button @click="toggleProductStatus(p)" class="btn-outline" style="padding: 5px;">{{ p.hidden ? '–ü–û–ö–ê–ó–ê–¢–¨' : '–°–ö–†–´–¢–¨' }}</button>
                        <button @click="deleteProduct(p.id)" style="color: red; border: none; background: none; font-size: 18px;">‚úï</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <transition name="fade">
        <div v-if="selP" class="screen-view">
            <button class="close-screen" @click="selP = null">‚úï</button>
            <div class="slider-wrapper" style="aspect-ratio: 1/1.2;">
                <div class="slider-inner" @scroll="e => handleScroll(e, selP)">
                    <img v-for="img in selP.images" :src="img">
                </div>
                <div class="dots" v-if="selP.images?.length > 1">
                    <span v-for="(img, idx) in selP.images" class="dot" :class="{active: idx === (selP.aIdx || 0)}"></span>
                </div>
            </div>
            
            <div style="padding: 25px;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <h1 style="font-size: 18px; text-transform: uppercase; margin: 0; font-weight: 800; letter-spacing: 1px;">{{selP.title}}</h1>
                    <div style="text-align: right;">
                        <div style="font-size: 20px; font-weight: 800;">{{selP.price}} ‚ÇΩ</div>
                        <div v-if="selP.oldPrice" style="text-decoration: line-through; color: #999; font-size: 13px;">{{selP.oldPrice}} ‚ÇΩ</div>
                    </div>
                </div>
                
                <p style="font-size: 13px; line-height: 1.8; color: #444; margin: 25px 0;">{{selP.desc}}</p>

                <div style="margin: 25px 0;">
                    <label style="font-size: 9px; font-weight: 800; letter-spacing: 2px;">–í–´–ë–ï–†–ò–¢–ï –†–ê–ó–ú–ï–†</label>
                    <div class="size-grid">
                        <div v-for="s in selP.sizes" :key="s" class="size-box" :class="{active: selP.selectedSize === s}" @click="selP.selectedSize = s; vibrate()">
                            {{s}}
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 30px;">
                    <button class="btn-outline" style="width: 60px; height: 55px; display: flex; align-items: center; justify-content: center; border-radius: 0;" @click="toggleFav(selP)">
                        <svg :fill="isFav(selP) ? 'black' : 'none'" stroke="black" stroke-width="1.5" viewBox="0 0 24 24" width="22"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                    </button>
                    <button class="btn-black" style="flex: 1; height: 55px;" @click="addToCart(selP)">–í –ö–û–†–ó–ò–ù–£</button>
                </div>
            </div>
        </div>
    </transition>

    <nav class="bottom-nav">
        <button @click="activeTab = 'catalog'; vibrate()" :class="['nav-item', activeTab === 'catalog' ? 'active' : '']">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
            <span>–ö–ê–¢–ê–õ–û–ì</span>
        </button>
        <button @click="activeTab = 'favs'; vibrate()" :class="['nav-item', activeTab === 'favs' ? 'active' : '']">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
            <span>–ò–ó–ë–†–ê–ù–ù–û–ï</span>
        </button>
        <button @click="activeTab = 'cart'; vibrate()" :class="['nav-item', activeTab === 'cart' ? 'active' : '']">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg>
            <span v-if="cart.length > 0" class="badge">{{cart.length}}</span>
            <span>–ö–û–†–ó–ò–ù–ê</span>
        </button>
        <button @click="activeTab = 'profile'; vibrate()" :class="['nav-item', activeTab === 'profile' ? 'active' : '']">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            <span>–ü–†–û–§–ò–õ–¨</span>
        </button>
    </nav>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC6fihIMtOYZuPh-db3Tc6eiRgSikzydVw",
        authDomain: "naran-80077.firebaseapp.com",
        projectId: "naran-80077",
        storageBucket: "naran-80077.firebasestorage.app",
        messagingSenderId: "901156477154",
        appId: "IG-PR8PLCMF3C"
    };

    const fbApp = initializeApp(firebaseConfig);
    const db = getFirestore(fbApp);

    const { createApp } = Vue;
    const tg = window.Telegram.WebApp;

    createApp({
        data() {
            return {
                tg,
                activeTab: 'catalog',
                products: [],
                orders: [],
                myOrders: [],
                categories: ['–ø–∏–¥–∂–∞–∫–∏', '—Å–≤–∏—Ç–µ—Ä—ã', '–∫–∞—Ä–¥–∏–≥–∞–Ω—ã', '–∫–æ—Å—Ç—é–º—ã', '–ª–æ–Ω–≥—Å–ª–∏–≤—ã', '—Ñ—É—Ç–±–æ–ª–∫–∏', '–∫–æ—Ä—Å–µ—Ç—ã', '–∫—É—Ä—Ç–∫–∏', '—ç–∫–æ—à—É–±—ã'],
                currentCat: '',
                searchQuery: '',
                showSearch: false,
                uploading: false,
                isAdmin: false,
                adminId: 387881523, 
                user: {},
                cart: JSON.parse(localStorage.getItem('n_cart') || '[]'),
                favorites: JSON.parse(localStorage.getItem('n_favs') || '[]'),
                selP: null,
                deliv: '',
                address: localStorage.getItem('n_last_adr') || '',
                form: { name: '', phone: localStorage.getItem('n_phone') || '' },
                newP: { title: '', desc: '', price: '', oldPrice: '', category: '–ø–∏–¥–∂–∞–∫–∏', images: [], sizesInput: '42, 44, 46' },
                map: null
            }
        },
        computed: {
            filteredProducts() {
                try {
                    let list = this.products;
                    // –°–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                    if (this.currentCat !== '') {
                        list = list.filter(p => p.category && p.category.toLowerCase() === this.currentCat.toLowerCase());
                    }
                    // –ü–æ–∏—Å–∫
                    if (this.searchQuery) {
                        const q = this.searchQuery.toLowerCase();
                        list = list.filter(p => p.title.toLowerCase().includes(q));
                    }
                    // –°–∫—Ä—ã—Ç—ã–µ —Ç–æ–≤–∞—Ä—ã –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω
                    return this.isAdmin ? list : list.filter(p => !p.hidden);
                } catch(e) { 
                    console.error("–û—à–∏–±–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:", e);
                    return []; 
                }
            },
            favItems() {
                // –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ ID –∏–∑ favorites —Å –æ–±—ä–µ–∫—Ç–∞–º–∏ –∏–∑ products
                return this.products.filter(p => this.favorites.some(f => (f.id || f) === p.id));
            },
            total() {
                return this.cart.reduce((s, i) => s + (i.price * (i.qty || 1)), 0);
            },
            isFormValid() {
                const phoneReg = /^\d{10,11}$/;
                return this.form.name.length > 1 && phoneReg.test(this.form.phone) && this.address;
            }
        },
        methods: {
            vibrate() { tg.HapticFeedback.impactOccurred('medium'); },
            handleScroll(e, p) { 
                if(!p) return;
                p.aIdx = Math.round(e.target.scrollLeft / e.target.offsetWidth); 
            },
            openProduct(p) {
                this.vibrate();
                this.selP = { ...p, selectedSize: p.sizes ? p.sizes[0] : '' };
            },
            toggleFav(p) {
                this.vibrate();
                const idx = this.favorites.findIndex(f => (f.id || f) === p.id);
                if (idx > -1) {
                    this.favorites.splice(idx, 1);
                } else {
                    this.favorites.push({ id: p.id, size: p.selectedSize || '42' });
                }
                localStorage.setItem('n_favs', JSON.stringify(this.favorites));
            },
            isFav(p) { return this.favorites.some(f => (f.id || f) === p.id); },
            
            addToCart(p) {
                if (!p.selectedSize) { tg.showAlert("–í–´–ë–ï–†–ò–¢–ï –†–ê–ó–ú–ï–†"); return; }
                const item = { 
                    cartId: Date.now(), 
                    id: p.id, 
                    title: p.title, 
                    price: p.price, 
                    img: p.img, 
                    selectedSize: p.selectedSize, 
                    qty: 1 
                };
                this.cart.push(item);
                localStorage.setItem('n_cart', JSON.stringify(this.cart));
                this.selP = null;
                tg.HapticFeedback.notificationOccurred('success');
            },
            removeFromCart(idx) {
                this.cart.splice(idx, 1);
                localStorage.setItem('n_cart', JSON.stringify(this.cart));
            },
            updateQty(idx, val) {
                this.cart[idx].qty = Math.max(1, (this.cart[idx].qty || 1) + val);
                localStorage.setItem('n_cart', JSON.stringify(this.cart));
            },

            setDelivery(d) {
                this.deliv = d;
                this.vibrate();
                this.$nextTick(() => this.initMap());
            },
            initMap() {
                if (this.map) { this.map.destroy(); }
                this.map = new mapgl.Map('map', {
                    center: [37.6175, 55.7558],
                    zoom: 12,
                    key: 'cab82c94-e619-42eb-9814-3361712feaf0'
                });
                
                this.map.on('click', (e) => {
                    this.fetchAddress(e.lngLat[1], e.lngLat[0]);
                });

                navigator.geolocation.getCurrentPosition(p => {
                    this.map.setCenter([p.coords.longitude, p.coords.latitude]);
                    this.fetchAddress(p.coords.latitude, p.coords.longitude);
                }, () => {});
            },
            fetchAddress(lat, lon) {
                fetch(`https://catalog.api.2gis.com/3.0/items/geocode?lat=${lat}&lon=${lon}&fields=items.address&key=cab82c94-e619-42eb-9814-3361712feaf0`)
                .then(r => r.json())
                .then(d => {
                    if (d.result?.items?.length > 0) {
                        this.address = d.result.items[0].address_name || d.result.items[0].name;
                        localStorage.setItem('n_last_adr', this.address);
                    }
                });
            },
            showInfo(type) {
                const info = {
                    about: "NARAN PREMIUM ‚Äî –†–û–°–°–ò–ô–°–ö–ò–ô –ë–†–ï–ù–î –û–î–ï–ñ–î–´, –û–°–ù–û–í–ê–ù–ù–´–ô –ù–ê –ü–†–ò–ù–¶–ò–ü–ê–• –ú–ò–ù–ò–ú–ê–õ–ò–ó–ú–ê –ò –ö–ê–ß–ï–°–¢–í–ê.",
                    delivery: "–î–û–°–¢–ê–í–ö–ê –ü–û –†–§: –°–î–≠–ö, –ü–û–ß–¢–ê –†–û–°–°–ò–ò, 5POST. –°–†–û–ö–ò: 2-7 –î–ù–ï–ô.",
                    returns: "–í–û–ó–í–†–ê–¢ –í–û–ó–ú–û–ñ–ï–ù –í –¢–ï–ß–ï–ù–ò–ï 14 –î–ù–ï–ô –ü–†–ò –°–û–•–†–ê–ù–ï–ù–ò–ò –¢–û–í–ê–†–ù–û–ì–û –í–ò–î–ê."
                };
                tg.showAlert(info[type]);
            },

            // ADMIN
            triggerFiles() { document.getElementById('fileInput').click(); },
            async handleFileUpload(e) {
                const files = e.target.files;
                if(!files.length) return;
                this.uploading = true;
                for (let file of files) {
                    const body = new FormData();
                    body.append('image', file);
                    try {
                        const res = await fetch('https://api.imgbb.com/1/upload?key=839e62907e9a52f0159461b7771bcb2f', { method: 'POST', body });
                        const data = await res.json();
                        if (data.success) this.newP.images.push(data.data.url);
                    } catch (err) { 
                        tg.showAlert("–û–®–ò–ë–ö–ê –ó–ê–ì–†–£–ó–ö–ò –§–û–¢–û"); 
                    }
                }
                this.uploading = false;
            },
            async saveProduct() {
                if (!this.newP.title || this.newP.images.length === 0 || !this.newP.price) {
                    tg.showAlert("–ó–ê–ü–û–õ–ù–ò–¢–ï –í–°–ï –ü–û–õ–Ø");
                    return;
                }
                try {
                    const data = {
                        title: this.newP.title,
                        desc: this.newP.desc,
                        price: Number(this.newP.price),
                        oldPrice: Number(this.newP.oldPrice) || null,
                        category: this.newP.category,
                        sizes: this.newP.sizesInput.split(',').map(s => s.trim()),
                        images: this.newP.images,
                        img: this.newP.images[0],
                        hidden: false,
                        createdAt: serverTimestamp()
                    };
                    await addDoc(collection(db, "products"), data);
                    tg.showAlert("–¢–û–í–ê–† –î–û–ë–ê–í–õ–ï–ù");
                    this.newP = { title: '', desc: '', price: '', oldPrice: '', category: '–ø–∏–¥–∂–∞–∫–∏', images: [], sizesInput: '42, 44, 46' };
                } catch(e) { tg.showAlert("–û–®–ò–ë–ö–ê: " + e.message); }
            },
            async checkout() {
                this.vibrate();
                const now = new Date();
                const orderId = `${now.getDate()}${now.getMonth()+1}-${Math.floor(10000+Math.random()*89999)}`;
                
                const orderData = {
                    order_id: orderId,
                    user: this.form,
                    user_id: this.user.id || 'guest',
                    cart: this.cart,
                    total: this.total,
                    delivery: this.deliv,
                    address: this.address,
                    status: '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ',
                    createdAt: serverTimestamp()
                };

                try {
                    await addDoc(collection(db, "orders"), orderData);
                    localStorage.setItem('n_phone', this.form.phone);
                    
                    // –û—Ç–ø—Ä–∞–≤–∫–∞ –±–æ—Ç—É (—á–µ—Ä–µ–∑ sendData)
                    tg.sendData(JSON.stringify({type: 'order', ...orderData}));
                    
                    this.cart = [];
                    localStorage.removeItem('n_cart');
                    tg.showAlert(`–ó–ê–ö–ê–ó ‚Ññ${orderId} –ü–†–ò–ù–Ø–¢!`);
                    this.activeTab = 'profile';
                } catch(e) { tg.showAlert("–û–®–ò–ë–ö–ê –û–§–û–†–ú–õ–ï–ù–ò–Ø"); }
            },
            getStatusColor(s) {
                const colors = { '–í –ø—É—Ç–∏': '#0055ff', '–ì–æ—Ç–æ–≤': '#00aa00', '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ': '#ffaa00', '–û–ø–ª–∞—á–µ–Ω–æ': '#000' };
                return colors[s] || '#999';
            },
            async updateOrderStatus(id, status) {
                await updateDoc(doc(db, "orders", id), { status });
            },
            async toggleProductStatus(p) {
                await updateDoc(doc(db, "products", p.id), { hidden: !p.hidden });
            },
            async deleteProduct(id) {
                if (confirm("–£–î–ê–õ–ò–¢–¨ –¢–û–í–ê–†?")) await deleteDoc(doc(db, "products", id));
            }
        },
        mounted() {
            tg.ready();
            tg.expand();
            
            if (tg.initDataUnsafe?.user) {
                this.user = tg.initDataUnsafe.user;
                if (Number(this.user.id) === Number(this.adminId)) {
                    this.isAdmin = true;
                }
            }

            // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Ç–æ–≤–∞—Ä—ã
            onSnapshot(query(collection(db, "products"), orderBy("createdAt", "desc")), (snap) => {
                this.products = snap.docs.map(d => ({ id: d.id, ...d.data(), aIdx: 0 }));
            });

            // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∑–∞–∫–∞–∑—ã
            onSnapshot(query(collection(db, "orders"), orderBy("createdAt", "desc")), (snap) => {
                const all = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                this.orders = all;
                if (this.user.id) {
                    this.myOrders = all.filter(o => String(o.user_id) === String(this.user.id));
                }
            });
        }
    }).mount('#app');
</script>

</body>
</html>
