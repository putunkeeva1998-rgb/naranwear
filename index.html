<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NARAN</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://mapgl.2gis.com/api/js/v1"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #ffffff;
            --text: #000000;
            --accent: #000000;
            --gray: #f4f4f4;
            --dark-gray: #7a7a7a;
            --border: #e5e5e5;
            --red: #ff3b30;
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            outline: none; 
            font-family: 'Montserrat', sans-serif;
        }
        
        body { 
            margin: 0; 
            background: var(--bg); 
            color: var(--text); 
            overflow-x: hidden; 
        }

        /* –•–µ–¥–µ—Ä */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            background: #fff;
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid var(--border);
        }

        .brand-name { font-weight: 800; font-size: 20px; letter-spacing: 2px; }

        /* –ü–æ–∏—Å–∫ */
        .search-bar {
            padding: 10px 20px;
            background: #fff;
            border-bottom: 1px solid var(--border);
        }
        .search-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--text);
            border-radius: 0;
            font-size: 14px;
        }

        .container { padding: 15px; padding-bottom: 100px; }

        /* –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ */
        .cat-row { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 20px; 
            overflow-x: auto; 
            padding-bottom: 5px; 
            scrollbar-width: none;
        }
        .cat-row::-webkit-scrollbar { display: none; }
        
        .cat-btn {
            padding: 10px 18px;
            border: 1px solid var(--text);
            background: #fff;
            color: var(--text);
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            white-space: nowrap;
            cursor: pointer;
        }
        .cat-btn.active { background: var(--text); color: #fff; }

        /* –°–µ—Ç–∫–∞ */
        .products-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 15px; 
        }

        .card { 
            background: #fff; 
            position: relative; 
            display: flex; 
            flex-direction: column; 
        }

        .slider-wrapper { 
            position: relative; 
            width: 100%; 
            aspect-ratio: 3/4; 
            overflow: hidden; 
            background: var(--gray);
        }
        .slider-inner { 
            display: flex; 
            overflow-x: auto; 
            scroll-snap-type: x mandatory; 
            scrollbar-width: none; 
            height: 100%; 
        }
        .slider-inner::-webkit-scrollbar { display: none; }
        .slider-inner img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            scroll-snap-align: start; 
            flex-shrink: 0; 
        }

        .card-info { padding: 10px 0; }
        .card-title { font-size: 11px; font-weight: 700; text-transform: uppercase; margin-bottom: 4px; height: 30px; overflow: hidden; }
        .card-price { font-weight: 800; font-size: 14px; }
        .old-price { text-decoration: line-through; color: var(--dark-gray); font-size: 12px; margin-left: 5px; }

        .card-btns {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }
        .btn-icon {
            flex: 1;
            padding: 10px;
            background: #fff;
            border: 1px solid var(--text);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .btn-buy {
            flex: 3;
            background: var(--text);
            color: #fff;
            border: none;
            font-weight: 800;
            font-size: 10px;
            text-transform: uppercase;
        }

        /* Bottom Nav */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #fff;
            display: flex;
            justify-content: space-around;
            padding: 12px 0 25px 0;
            border-top: 1px solid var(--border);
            z-index: 2000;
        }
        .nav-item {
            border: none;
            background: none;
            color: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            gap: 5px;
            position: relative;
        }
        .nav-item svg { width: 22px; height: 22px; stroke: currentColor; stroke-width: 1.5; fill: none; }
        .nav-item.active { color: var(--text); }
        .badge {
            position: absolute;
            top: -5px;
            right: 10px;
            background: var(--red);
            color: #fff;
            font-size: 9px;
            padding: 2px 5px;
            border-radius: 10px;
        }

        /* Modal Product */
        .modal-full {
            position: fixed;
            inset: 0;
            background: #fff;
            z-index: 3000;
            overflow-y: auto;
        }
        .close-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 3100;
            background: #000;
            color: #fff;
            width: 35px;
            height: 35px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: none;
        }

        /* Forms */
        .input-naran {
            width: 100%;
            padding: 15px;
            border: 1px solid var(--text);
            margin-bottom: 10px;
            font-size: 14px;
        }
        .btn-naran {
            width: 100%;
            padding: 18px;
            background: #000;
            color: #fff;
            border: none;
            font-weight: 800;
            text-transform: uppercase;
            cursor: pointer;
        }
        
        #map { width: 100%; height: 300px; margin: 15px 0; border: 1px solid #000; }

        .size-selector { display: flex; gap: 8px; margin: 15px 0; flex-wrap: wrap; }
        .size-chip {
            padding: 12px 20px;
            border: 1px solid var(--text);
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
        }
        .size-chip.active { background: #000; color: #fff; }

        /* Admin Styles */
        .admin-section {
            background: var(--gray);
            padding: 15px;
            margin-top: 20px;
            border: 1px dashed #000;
        }
        .order-card {
            border: 1px solid #000;
            padding: 15px;
            margin-bottom: 15px;
            background: #fff;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            font-size: 10px;
            font-weight: 800;
            background: #000;
            color: #fff;
            margin-bottom: 10px;
        }

        .dots { position: absolute; bottom: 10px; width: 100%; text-align: center; }
        .dot { display: inline-block; width: 5px; height: 5px; background: rgba(0,0,0,0.2); margin: 0 3px; border-radius: 50%; }
        .dot.active { background: #000; width: 15px; border-radius: 10px; transition: 0.3s; }
    </style>
</head>
<body>

<div id="app">
    <header class="header">
        <button @click="toggleMenu" style="border:none; background:none;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="1.5"><path d="M3 12h18M3 6h18M3 18h18"/></svg>
        </button>
        <div class="brand-name">NARAN</div>
        <button @click="showSearch = !showSearch" style="border:none; background:none;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="1.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
        </button>
    </header>

    <div v-if="showSearch" class="search-bar">
        <input v-model="searchQuery" class="search-input" placeholder="–ü–û–ò–°–ö –¢–û–í–ê–†–ê...">
    </div>

    <div v-if="showInfo" style="position:fixed; inset:0; background:rgba(255,255,255,0.98); z-index:4000; padding:40px;">
        <button @click="showInfo = false" class="close-btn">‚úï</button>
        <h2 style="font-weight:800; margin-bottom:30px;">–ò–ù–§–û–†–ú–ê–¶–ò–Ø</h2>
        <div style="display:flex; flex-direction:column; gap:25px; font-weight:700;">
            <div @click="activeInfo = 'about'">–û –ù–ê–°</div>
            <div @click="activeInfo = 'returns'">–í–û–ó–í–†–ê–¢</div>
            <div @click="activeInfo = 'delivery'">–î–û–°–¢–ê–í–ö–ê</div>
        </div>
        <div v-if="activeInfo" style="margin-top:30px; font-size:14px; line-height:1.6; padding:20px; background:#f9f9f9;">
            <div v-if="activeInfo === 'about'">NARAN ‚Äî —Ä–æ—Å—Å–∏–π—Å–∫–∏–π –±—Ä–µ–Ω–¥ –ø—Ä–µ–º–∏–∞–ª—å–Ω–æ–π –æ–¥–µ–∂–¥—ã, —Å–æ–∑–¥–∞–Ω–Ω—ã–π –¥–ª—è —Ü–µ–Ω–∏—Ç–µ–ª–µ–π –∫–∞—á–µ—Å—Ç–≤–∞ –∏ –º–∏–Ω–∏–º–∞–ª–∏–∑–º–∞.</div>
            <div v-if="activeInfo === 'returns'">–í–æ–∑–≤—Ä–∞—Ç –≤–æ–∑–º–æ–∂–µ–Ω –≤ —Ç–µ—á–µ–Ω–∏–µ 14 –¥–Ω–µ–π —Å –º–æ–º–µ–Ω—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–Ω–æ–≥–æ –≤–∏–¥–∞ –∏ –±–∏—Ä–æ–∫.</div>
            <div v-if="activeInfo === 'delivery'">–î–æ—Å—Ç–∞–≤–∫–∞ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –ø–æ –≤—Å–µ–π –†–æ—Å—Å–∏–∏: –°–î–≠–ö, –ü–æ—á—Ç–∞ –†–æ—Å—Å–∏–∏, 5Post. –°—Ä–æ–∫ 2-10 –¥–Ω–µ–π.</div>
        </div>
    </div>

    <main class="container">
        <div v-if="activeTab === 'catalog'">
            <div class="cat-row">
                <button @click="changeCat('')" :class="['cat-btn', currentCat === '' ? 'active' : '']">–í–°–ï –¢–û–í–ê–†–´</button>
                <button v-for="c in categories" :key="c.id" @click="changeCat(c.name)" :class="['cat-btn', currentCat === c.name ? 'active' : '']">
                    {{c.name}}
                </button>
            </div>

            <div v-if="filteredProducts.length === 0" style="text-align:center; padding:50px;">–¢–û–í–ê–†–´ –ù–ï –ù–ê–ô–î–ï–ù–´</div>
            
            <div class="products-grid">
                <div v-for="p in filteredProducts" :key="p.id" class="card" @click="openProduct(p)">
                    <div class="slider-wrapper">
                        <div class="slider-inner" @scroll="e => handleSlider(e, p)">
                            <img v-for="img in p.images" :src="img" :key="img">
                        </div>
                        <div class="dots">
                            <span v-for="(img, idx) in p.images" :class="['dot', p.aIdx === idx ? 'active' : '']"></span>
                        </div>
                    </div>
                    <div class="card-info">
                        <div class="card-title">{{p.title}}</div>
                        <div class="card-price">
                            {{p.price}} ‚ÇΩ <span v-if="p.oldPrice" class="old-price">{{p.oldPrice}} ‚ÇΩ</span>
                        </div>
                        <div style="font-size:9px; color:gray; margin-top:5px;">–†–ê–ó–ú–ï–†–´: {{p.sizes.join(', ')}}</div>
                    </div>
                    <div class="card-btns">
                        <button class="btn-icon" @click.stop="toggleFav(p)">
                            <svg v-if="!isFav(p)" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="black"><path d="M20.8 4.6a5.5 5.5 0 0 0-7.7 0l-1.1 1-1.1-1a5.5 5.5 0 0 0-7.7 7.8l1.1 1 7.7 7.8 7.7-7.8 1.1-1a5.5 5.5 0 0 0 0-7.8z"/></svg>
                            <svg v-else width="18" height="18" viewBox="0 0 24 24" fill="black"><path d="M20.8 4.6a5.5 5.5 0 0 0-7.7 0l-1.1 1-1.1-1a5.5 5.5 0 0 0-7.7 7.8l1.1 1 7.7 7.8 7.7-7.8 1.1-1a5.5 5.5 0 0 0 0-7.8z"/></svg>
                        </button>
                        <button class="btn-buy" @click.stop="openProduct(p)">–í –ö–û–†–ó–ò–ù–£</button>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="activeTab === 'favs'">
            <h2 style="font-weight:800; font-size:18px; margin-bottom:20px;">–ò–ó–ë–†–ê–ù–ù–û–ï</h2>
            <div v-if="favorites.length === 0" style="text-align:center; margin-top:50px; color:gray;">–ó–î–ï–°–¨ –ü–û–ö–ê –ü–£–°–¢–û</div>
            <div class="products-grid">
                <div v-for="p in favItems" :key="p.id" class="card" @click="openProduct(p)">
                    <div class="slider-wrapper">
                        <img :src="p.images[0]" style="width:100%; height:100%; object-fit:cover;">
                    </div>
                    <div class="card-info">
                        <div class="card-title">{{p.title}}</div>
                        <div class="card-price">{{p.price}} ‚ÇΩ</div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="activeTab === 'cart'">
            <h2 style="font-weight:800; font-size:18px; margin-bottom:20px;">–ö–û–†–ó–ò–ù–ê</h2>
            <div v-if="cart.length === 0" style="text-align:center; padding:50px; color:gray;">–ö–û–†–ó–ò–ù–ê –ü–£–°–¢–ê</div>
            
            <div v-else>
                <div v-for="(item, idx) in cart" :key="item.cartId" style="display:flex; gap:15px; margin-bottom:20px; padding-bottom:15px; border-bottom:1px solid #eee;">
                    <img :src="item.images[0]" style="width:80px; height:100px; object-fit:cover;">
                    <div style="flex:1;">
                        <div style="font-weight:700; font-size:12px;">{{item.title}}</div>
                        <div style="font-size:11px; color:gray; margin:5px 0;">–†–ê–ó–ú–ï–†: {{item.selectedSize}} | –¶–í–ï–¢: {{item.color}}</div>
                        <div style="font-weight:800; margin-bottom:10px;">{{item.price * item.count}} ‚ÇΩ</div>
                        <div style="display:flex; align-items:center; gap:15px;">
                            <button @click="changeCount(idx, -1)" style="border:1px solid #000; background:none; width:25px;">-</button>
                            <span style="font-weight:700;">{{item.count}}</span>
                            <button @click="changeCount(idx, 1)" style="border:1px solid #000; background:none; width:25px;">+</button>
                        </div>
                    </div>
                    <button @click="removeFromCart(idx)" style="border:none; background:none; color:red; font-size:18px;">‚úï</button>
                </div>

                <div style="margin-top:30px;">
                    <h3 style="font-size:14px; font-weight:800;">–û–§–û–†–ú–õ–ï–ù–ò–ï –ó–ê–ö–ê–ó–ê</h3>
                    <input v-model="form.name" class="input-naran" placeholder="–ò–ú–Ø">
                    <input v-model="form.phone" class="input-naran" placeholder="–¢–ï–õ–ï–§–û–ù (11 –¶–ò–§–†)" type="tel">
                    
                    <div style="display:flex; gap:5px; margin-top:10px;">
                        <button v-for="d in ['–°–î–≠–ö', '–ü–æ—á—Ç–∞', '5post']" @click="setDelivery(d)" :class="['cat-btn', deliv === d ? 'active' : '']" style="flex:1;">{{d}}</button>
                    </div>

                    <div v-show="deliv">
                        <div id="map"></div>
                        <div style="font-size:11px; font-weight:700; margin-bottom:15px;">üìç {{address || '–í–´–ë–ï–†–ò–¢–ï –ü–£–ù–ö–¢ –ù–ê –ö–ê–†–¢–ï'}}</div>
                    </div>

                    <button @click="placeOrder" class="btn-naran" :disabled="!isOrderValid">–û–§–û–†–ú–ò–¢–¨ –ó–ê–ö–ê–ó ‚Ä¢ {{totalCart}} ‚ÇΩ</button>
                </div>
            </div>
        </div>

        <div v-if="activeTab === 'profile'">
            <div style="text-align:center; padding:20px;">
                <img :src="user.photo_url || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'" style="width:80px; height:80px; border-radius:50%; border:1px solid #000; padding:3px;">
                <h2 style="font-weight:800; margin:10px 0;">{{user.first_name || '–ì–û–°–¢–¨'}}</h2>
                <button @click="openSupport" class="cat-btn">–ü–û–î–î–ï–†–ñ–ö–ê</button>
            </div>

            <div style="margin-top:30px;">
                <h3 style="font-weight:800; font-size:14px; border-bottom:2px solid #000; padding-bottom:5px;">–ú–û–ò –ó–ê–ö–ê–ó–´</h3>
                <div v-if="userOrders.length === 0" style="color:gray; padding:20px; text-align:center;">–£ –í–ê–° –ù–ï–¢ –ó–ê–ö–ê–ó–û–í</div>
                <div v-for="o in userOrders" :key="o.id" class="order-card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-weight:800; font-size:12px;">‚Ññ {{o.orderId}}</span>
                        <span class="status-badge">{{o.status || '–í –û–ë–†–ê–ë–û–¢–ö–ï'}}</span>
                    </div>
                    <div style="font-size:11px; margin-top:10px;">–°–£–ú–ú–ê: {{o.total}} ‚ÇΩ</div>
                    <div style="font-size:10px; color:gray;">{{new Date(o.date).toLocaleDateString()}}</div>
                </div>
            </div>

            <div v-if="isAdmin" class="admin-section">
                <h2 style="font-weight:800; text-align:center;">ADMIN PANEL</h2>
                
                <div style="background:#fff; padding:15px; border:1px solid #000; margin-bottom:20px;">
                    <h3 style="font-size:12px; font-weight:800;">+ –î–û–ë–ê–í–ò–¢–¨ –¢–û–í–ê–†</h3>
                    <input v-model="newP.title" class="input-naran" placeholder="–ù–ê–ó–í–ê–ù–ò–ï">
                    <textarea v-model="newP.desc" class="input-naran" placeholder="–û–ü–ò–°–ê–ù–ò–ï"></textarea>
                    <input v-model="newP.price" class="input-naran" type="number" placeholder="–¶–ï–ù–ê">
                    <input v-model="newP.oldPrice" class="input-naran" type="number" placeholder="–°–¢–ê–†–ê–Ø –¶–ï–ù–ê (SALE)">
                    <input v-model="newP.color" class="input-naran" placeholder="–¶–í–ï–¢">
                    <input v-model="newP.sizesInput" class="input-naran" placeholder="–†–ê–ó–ú–ï–†–´ (–ß–ï–†–ï–ó –ó–ê–ü–Ø–¢–£–Æ: 42, 44, 46)">
                    
                    <select v-model="newP.category" class="input-naran">
                        <option value="">–í–´–ë–ï–†–ò–¢–ï –ö–ê–¢–ï–ì–û–†–ò–Æ</option>
                        <option v-for="c in categories" :value="c.name">{{c.name}}</option>
                    </select>

                    <div style="margin:10px 0;">
                        <label style="font-size:10px; font-weight:800;">–§–û–¢–û (–ú–û–ñ–ù–û –ù–ï–°–ö–û–õ–¨–ö–û):</label>
                        <input type="file" multiple @change="handleFiles" class="input-naran" style="border:none; padding:5px;">
                    </div>

                    <button @click="addProduct" class="btn-naran" :disabled="uploading">
                        {{ uploading ? '–ó–ê–ì–†–£–ó–ö–ê...' : '–û–ü–£–ë–õ–ò–ö–û–í–ê–¢–¨' }}
                    </button>
                </div>

                <div style="background:#fff; padding:15px; border:1px solid #000; margin-bottom:20px;">
                   <h3 style="font-size:12px; font-weight:800;">–£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–ê–¢–ï–ì–û–†–ò–Ø–ú–ò</h3>
                   <div style="display:flex; gap:5px;">
                       <input v-model="newCatName" class="input-naran" style="margin:0;" placeholder="–ù–û–í–ê–Ø –ö–ê–¢–ï–ì–û–†–ò–Ø">
                       <button @click="addCategory" class="cat-btn">–î–û–ë–ê–í–ò–¢–¨</button>
                   </div>
                   <div style="margin-top:10px;">
                       <div v-for="c in categories" :key="c.id" style="display:flex; justify-content:space-between; margin-bottom:5px;">
                           <span>{{c.name}}</span>
                           <button @click="deleteCategory(c.id)" style="color:red; border:none; background:none;">–£–î–ê–õ–ò–¢–¨</button>
                       </div>
                   </div>
                </div>

                <div style="background:#fff; padding:15px; border:1px solid #000;">
                    <h3 style="font-size:12px; font-weight:800;">–í–°–ï –ó–ê–ö–ê–ó–´</h3>
                    <div v-for="o in allOrders" :key="o.id" class="order-card">
                        <div><b>{{o.orderId}}</b> - {{o.user.name}}</div>
                        <div style="font-size:11px;">{{o.address}}</div>
                        <div style="margin:10px 0;">
                            <div v-for="item in o.cart" style="font-size:10px;">‚Ä¢ {{item.title}} ({{item.selectedSize}}) x {{item.count}}</div>
                        </div>
                        <select @change="updateOrderStatus(o.id, $event.target.value)" class="input-naran" style="padding:5px; font-size:11px;">
                            <option :selected="o.status==='–í –û–ë–†–ê–ë–û–¢–ö–ï'">–í –û–ë–†–ê–ë–û–¢–ö–ï</option>
                            <option :selected="o.status==='–í –ü–£–¢–ò'">–í –ü–£–¢–ò</option>
                            <option :selected="o.status==='–ì–û–¢–û–í'">–ì–û–¢–û–í</option>
                        </select>
                        <button @click="printOrder(o)" style="font-size:10px; margin-top:5px; text-decoration:underline; border:none; background:none;">–ü–ï–ß–ê–¢–¨ –ß–ï–ö–ê</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div v-if="selP" class="modal-full">
        <button @click="selP = null" class="close-btn">‚úï</button>
        <div class="slider-wrapper" style="aspect-ratio:1/1.2;">
            <div class="slider-inner" @scroll="e => handleSlider(e, selP)">
                <img v-for="img in selP.images" :src="img">
            </div>
        </div>
        <div style="padding:20px;">
            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                <h2 style="font-weight:800; font-size:22px; margin:0; text-transform:uppercase;">{{selP.title}}</h2>
                <div style="font-weight:800; font-size:22px;">{{selP.price}} ‚ÇΩ</div>
            </div>
            
            <p style="color:gray; font-size:13px; line-height:1.6; margin:20px 0;">{{selP.desc}}</p>
            
            <div style="font-weight:800; font-size:12px; margin-bottom:10px;">–í–´–ë–ï–†–ò–¢–ï –†–ê–ó–ú–ï–†:</div>
            <div class="size-selector">
                <div v-for="s in selP.sizes" @click="selP.selectedSize = s; vibrate()" :class="['size-chip', selP.selectedSize === s ? 'active' : '']">{{s}}</div>
            </div>

            <button @click="addToCart(selP)" class="btn-naran" style="margin-top:20px;">–î–û–ë–ê–í–ò–¢–¨ –í –ö–û–†–ó–ò–ù–£</button>
        </div>
    </div>

    <nav class="bottom-nav">
        <button @click="setTab('catalog')" :class="['nav-item', activeTab === 'catalog' ? 'active' : '']">
            <svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
            –ö–ê–¢–ê–õ–û–ì
        </button>
        <button @click="setTab('favs')" :class="['nav-item', activeTab === 'favs' ? 'active' : '']">
            <svg viewBox="0 0 24 24"><path d="M20.8 4.6a5.5 5.5 0 0 0-7.7 0l-1.1 1-1.1-1a5.5 5.5 0 0 0-7.7 7.8l1.1 1 7.7 7.8 7.7-7.8 1.1-1a5.5 5.5 0 0 0 0-7.8z"/></svg>
            –ò–ó–ë–†–ê–ù–ù–û–ï
        </button>
        <button @click="setTab('cart')" :class="['nav-item', activeTab === 'cart' ? 'active' : '']">
            <svg viewBox="0 0 24 24"><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18M16 10a4 4 0 0 1-8 0"/></svg>
            –ö–û–†–ó–ò–ù–ê
            <span v-if="cart.length" class="badge">{{cart.length}}</span>
        </button>
        <button @click="setTab('profile')" :class="['nav-item', activeTab === 'profile' ? 'active' : '']">
            <svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            –ü–†–û–§–ò–õ–¨
        </button>
    </nav>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC6fihIMtOYZuPh-db3Tc6eiRgSikzydVw",
    authDomain: "naran-80077.firebaseapp.com",
    projectId: "naran-80077",
    storageBucket: "naran-80077.firebasestorage.app",
    messagingSenderId: "901156477154",
    appId: "IG-PR8PLCMF3C"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.db = db;
  window.fb = { collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, serverTimestamp, where };
</script>

<script>
    const tg = window.Telegram.WebApp;
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                activeTab: 'catalog',
                currentCat: '',
                searchQuery: '',
                showSearch: false,
                showInfo: false,
                activeInfo: null,
                isAdmin: false,
                adminId: 387881523,
                user: {},
                products: [],
                categories: [],
                favorites: JSON.parse(localStorage.getItem('naran_favs')) || [],
                cart: JSON.parse(localStorage.getItem('naran_cart')) || [],
                selP: null,
                deliv: '',
                address: localStorage.getItem('naran_last_address') || '',
                map: null,
                markers: [],
                uploading: false,
                userOrders: [],
                allOrders: [],
                newCatName: '',
                form: { name: '', phone: localStorage.getItem('naran_phone') || '' },
                newP: { title: '', desc: '', price: '', oldPrice: '', color: '', sizesInput: '42, 44, 46', category: '', images: [] }
            }
        },
        computed: {
            filteredProducts() {
                try {
                    let list = this.products || [];
                    if (this.currentCat) {
                        list = list.filter(p => p.category === this.currentCat);
                    }
                    if (this.searchQuery) {
                        const q = this.searchQuery.toLowerCase();
                        list = list.filter(p => p.title.toLowerCase().includes(q));
                    }
                    return list.filter(p => !p.hidden || this.isAdmin);
                } catch (e) {
                    console.error("Filter error:", e);
                    return [];
                }
            },
            favItems() {
                return (this.products || []).filter(p => this.favorites.includes(p.id));
            },
            totalCart() {
                return this.cart.reduce((sum, item) => sum + (item.price * item.count), 0);
            },
            isOrderValid() {
                return this.form.name.length > 1 && /^\d{10,11}$/.test(this.form.phone) && this.address && this.cart.length;
            }
        },
        methods: {
            vibrate() { tg.HapticFeedback.impactOccurred('medium'); },
            setTab(tab) { this.vibrate(); this.activeTab = tab; if(tab === 'cart' && this.deliv) this.initMap(); },
            toggleMenu() { this.vibrate(); this.showInfo = !this.showInfo; },
            changeCat(cat) { 
                try {
                    this.vibrate(); 
                    this.currentCat = cat || ''; 
                } catch(e) { 
                    this.currentCat = ''; 
                }
            },
            handleSlider(e, p) {
                p.aIdx = Math.round(e.target.scrollLeft / e.target.offsetWidth);
            },
            openProduct(p) {
                this.vibrate();
                this.selP = { ...p, selectedSize: p.sizes[0], aIdx: 0 };
            },
            isFav(p) { return this.favorites.includes(p.id); },
            toggleFav(p) {
                this.vibrate();
                const idx = this.favorites.indexOf(p.id);
                if (idx > -1) this.favorites.splice(idx, 1);
                else this.favorites.push(p.id);
                localStorage.setItem('naran_favs', JSON.stringify(this.favorites));
            },
            addToCart(p) {
                this.vibrate();
                const item = { ...p, cartId: Date.now(), count: 1 };
                this.cart.push(item);
                localStorage.setItem('naran_cart', JSON.stringify(this.cart));
                this.selP = null;
                tg.showScanQrPopup({ text: "–¢–û–í–ê–† –í –ö–û–†–ó–ò–ù–ï" }); setTimeout(() => tg.closeScanQrPopup(), 1000);
            },
            changeCount(idx, delta) {
                this.vibrate();
                this.cart[idx].count += delta;
                if (this.cart[idx].count < 1) this.cart.splice(idx, 1);
                localStorage.setItem('naran_cart', JSON.stringify(this.cart));
            },
            removeFromCart(idx) {
                this.vibrate();
                this.cart.splice(idx, 1);
                localStorage.setItem('naran_cart', JSON.stringify(this.cart));
            },
            setDelivery(type) {
                this.vibrate();
                this.deliv = type;
                this.initMap();
            },
            initMap() {
                this.$nextTick(() => {
                    setTimeout(() => {
                        if (this.map) this.map.destroy();
                        this.map = new mapgl.Map('map', {
                            center: [37.6175, 55.7558],
                            zoom: 12,
                            key: 'cab82c94-e619-42eb-9814-3361712feaf0'
                        });
                        this.map.on('click', (e) => {
                            this.vibrate();
                            this.getAddr(e.lngLat);
                        });
                        this.locate();
                    }, 300);
                });
            },
            locate() {
                navigator.geolocation.getCurrentPosition(pos => {
                    const coords = [pos.coords.longitude, pos.coords.latitude];
                    this.map.setCenter(coords);
                    new mapgl.Marker(this.map, { coordinates: coords });
                });
            },
            getAddr(ll) {
                fetch(`https://catalog.api.2gis.com/3.0/items/geocode?lat=${ll[1]}&lon=${ll[0]}&key=cab82c94-e619-42eb-9814-3361712feaf0`)
                    .then(r => r.json()).then(d => {
                        if (d.result?.items?.length) {
                            this.address = d.result.items[0].address_name || d.result.items[0].name;
                            localStorage.setItem('naran_last_address', this.address);
                        }
                    });
            },
            async handleFiles(e) {
                this.uploading = true;
                const files = e.target.files;
                for (let file of files) {
                    const fd = new FormData();
                    fd.append('image', file);
                    try {
                        const r = await fetch('https://api.imgbb.com/1/upload?key=839e62907e9a52f0159461b7771bcb2f', { method: 'POST', body: fd });
                        const d = await r.json();
                        this.newP.images.push(d.data.url);
                    } catch (err) { alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ"); }
                }
                this.uploading = false;
            },
            async addProduct() {
                if (!this.newP.images.length) return alert("–î–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ");
                this.vibrate();
                const p = {
                    ...this.newP,
                    price: Number(this.newP.price),
                    oldPrice: Number(this.newP.oldPrice),
                    sizes: this.newP.sizesInput.split(',').map(s => s.trim()),
                    hidden: false,
                    createdAt: window.fb.serverTimestamp()
                };
                await window.fb.addDoc(window.fb.collection(window.db, "products"), p);
                alert("–¢–û–í–ê–† –î–û–ë–ê–í–õ–ï–ù");
                this.newP = { title: '', desc: '', price: '', images: [], sizesInput: '42, 44, 46' };
            },
            async placeOrder() {
                this.vibrate();
                const orderId = `${new Date().getDate()}${new Date().getMonth()+1}-${Math.floor(10000+Math.random()*90000)}`;
                const order = {
                    orderId,
                    userId: this.user.id,
                    user: this.form,
                    cart: this.cart,
                    total: this.totalCart,
                    address: this.address,
                    delivery: this.deliv,
                    status: '–í –û–ë–†–ê–ë–û–¢–ö–ï',
                    date: Date.now()
                };
                await window.fb.addDoc(window.fb.collection(window.db, "orders"), order);
                localStorage.setItem('naran_phone', this.form.phone);
                
                // –û—Ç–ø—Ä–∞–≤–∫–∞ –±–æ—Ç—É —á–µ—Ä–µ–∑ tg.sendData
                tg.sendData(JSON.stringify({ type: 'new_order', ...order }));
                
                this.cart = [];
                localStorage.removeItem('naran_cart');
                tg.showAlert(`–ó–ê–ö–ê–ó ‚Ññ${orderId} –û–§–û–†–ú–õ–ï–ù!`);
                this.activeTab = 'profile';
            },
            async addCategory() {
                if (!this.newCatName) return;
                await window.fb.addDoc(window.fb.collection(window.db, "categories"), { name: this.newCatName.toUpperCase() });
                this.newCatName = '';
            },
            async deleteCategory(id) {
                if (confirm("–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é?")) await window.fb.deleteDoc(window.fb.doc(window.db, "categories", id));
            },
            async updateOrderStatus(id, status) {
                await window.fb.updateDoc(window.fb.doc(window.db, "orders", id), { status });
            },
            printOrder(o) {
                const win = window.open('', '_blank');
                win.document.write(`<h1>NARAN - –ó–ê–ö–ê–ó ‚Ññ${o.orderId}</h1><p>–ö–õ–ò–ï–ù–¢: ${o.user.name}</p><p>–¢–ï–õ: ${o.user.phone}</p><p>–ê–î–†–ï–°: ${o.address}</p><hr>`);
                o.cart.forEach(i => win.document.write(`<p>${i.title} - ${i.selectedSize} - ${i.count} —à—Ç.</p>`));
                win.document.write(`<h3>–ò–¢–û–ì–û: ${o.total} ‚ÇΩ</h3>`);
                win.print();
            },
            openSupport() { window.Telegram.WebApp.openTelegramLink('https://t.me/opttania'); }
        },
        mounted() {
            tg.ready();
            tg.expand();
            this.user = tg.initDataUnsafe?.user || { id: 123, first_name: '–¢–ï–°–¢' };
            this.isAdmin = Number(this.user.id) === this.adminId;

            const waitFB = setInterval(() => {
                if (window.db) {
                    clearInterval(waitFB);
                    
                    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
                    window.fb.onSnapshot(window.fb.query(window.fb.collection(window.db, "products"), window.fb.orderBy("createdAt", "desc")), snap => {
                        this.products = snap.docs.map(d => ({ id: d.id, ...d.data(), aIdx: 0 }));
                    });

                    // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
                    window.fb.onSnapshot(window.fb.collection(window.db, "categories"), snap => {
                        this.categories = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    });

                    // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    window.fb.onSnapshot(window.fb.query(window.fb.collection(window.db, "orders"), window.fb.where("userId", "==", this.user.id)), snap => {
                        this.userOrders = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    });

                    // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è –∞–¥–º–∏–Ω–∞
                    if (this.isAdmin) {
                        window.fb.onSnapshot(window.fb.query(window.fb.collection(window.db, "orders"), window.fb.orderBy("date", "desc")), snap => {
                            this.allOrders = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        });
                    }
                }
            }, 100);
        }
    }).mount('#app');
</script>

</body>
</html>
